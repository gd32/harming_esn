---
title: "Data Analysis"
author: "George Dewey, Hiroyasu Ando, Ryo Ikesu, Akihiro Nishi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This R Markdown document contains the data analysis and visualization code for the Main Text of our article, ***Spontaneous Peacebuilding and Calculated Harming***. For other analyses and figures, please refer to the Supplementary Materials attachment.

# Load data

```{r}
# Experiment 1 data
load("~/Documents/Projects/harming_esn/code/exp1/data1.Rdata") # The base dataset
load("~/Documents/Projects/harming_esn/code/exp1/data1_pc.Rdata") # Including punishment subtypes
load("~/Documents/Projects/harming_esn/code/exp1/ndata_individual.Rdata")
```

# Load helper functions

```{r}
mean1 = function(x) {mean(x,na.rm=TRUE)}
median1 = function(x) {median(x, na.rm = TRUE)}
```

# Results

## Experiment 1 - Descriptive Statistics

```{r}
# Number of actions
dim(data1)[1] #10727 recorded actions
```

```{r}
# Number of players
length(unique(data1$superid)) #745 unique participants 
```

```{r}
# Players per game, range
data1 %>%
  group_by(game) %>%
  select(superid) %>%
  unique() %>%
  summarize(n = n()) %>%
  summarize(mean_players = mean(n),
            min_players = min(n),
            max_players = max(n))
```

```{r}
# Behavior breakdown
data1 %>%
  mutate(behavior = case_when(behavior_coop == 1 ~ "C",
                              behavior_defect == 1 ~ "D",
                              behavior_punish == 1 ~ "P")) %>%
  group_by(behavior) %>%
  filter(behavior %in% c("C", "D", "P")) %>%
  summarize(n = n()) %>%
  mutate(perc = round(n/10727, 4))
```

```{r}
# CIs for proportions
prop.test(4878, 10727)
prop.test(4336, 10727)
prop.test(562, 10727)
```

```{r}
# Network statistics
mean1(data1$degree)
mean1(data1$transitivity)
```

```{r}
# Times per behavior
data1 %>%
  mutate(behavior = case_when(behavior_coop == 1 ~ "C",
                              behavior_defect == 1 ~ "D",
                              behavior_punish == 1 ~ "P"),
         behaviorTime_sec = behaviorTime/1000) %>%
  group_by(behavior) %>%
  filter(behavior %in% c("C", "D", "P")) %>%
  summarize(mean_dt = mean1(behaviorTime_sec))

# Calculating SEs
times_coop = data1 %>% filter(behavior_coop == 1) %>% select(behaviorTime_sec) %>% pull()
times_defect = data1 %>% filter(behavior_defect == 1) %>% select(behaviorTime_sec) %>% pull()
times_punish = data1 %>% filter(behavior_punish == 1) %>% select(behaviorTime_sec) %>% pull()

se_mean = function(x) sd(x)/sqrt(length(x))

mean1(times_coop)
round(mean1(times_coop)+ 1.96*se_mean(times_coop), 2)
round(mean1(times_coop)- 1.96*se_mean(times_coop), 2)

mean1(times_defect)
round(mean1(times_defect)+ 1.96*se_mean(times_defect), 2)
round(mean1(times_defect)- 1.96*se_mean(times_defect), 2)

mean1(times_punish)
round(mean1(times_punish)+ 1.96*se_mean(times_punish), 2)
round(mean1(times_punish)- 1.96*se_mean(times_punish), 2)
```

```{r}
# Punishment subtypes
data1_pc %>%
  filter(behavior_punish == 1) %>%
  mutate(costly_punish = ifelse(behavior_punish == 1 & local_rate_coop_lag < 0.5, 1, 0)) %>%
  group_by(costly_punish) %>%
  summarize(n = n()) #307

prop.test(307, 562)

data1_pc %>%
  filter(behavior_punish == 1) %>%
  group_by(wealth_inequal) %>%
  summarize(n = n()) # 279

prop.test(279, 562)

data1_pc %>%
  filter(behavior_punish == 1) %>%
  group_by(reactive_p) %>%
  summarize(n = n()) # 149
prop.test(149, 562)

data1_pc %>%
  filter(behavior_punish == 1) %>%
  group_by(unexplained_p) %>%
  summarize(n = n()) # 171
prop.test(171, 562)
```

```{r}
times_IA = data1_pc %>% filter(wealth_inequal == 1, behavior_punish == 1) %>% select(behaviorTime_sec) %>% pull()
times_RP = data1_pc %>% filter(reactive_p == 1) %>% select(behaviorTime_sec) %>% pull()
times_UE = data1_pc %>% filter(unexplained_p== 1) %>% select(behaviorTime_sec) %>% pull()

times_CP = data1_pc %>% 
  mutate(costly_punish = ifelse(behavior_punish == 1 & local_rate_coop_lag < 0.5, 1, 0)) %>%
  filter(costly_punish == 1) %>%
  select(behaviorTime_sec) %>% pull()

mean1(times_IA) 
mean1(times_IA) + 1.96*se_mean(times_IA)
mean1(times_IA) - 1.96*se_mean(times_IA)

mean1(times_RP) 
mean1(times_RP) + 1.96*se_mean(times_RP)
mean1(times_RP) - 1.96*se_mean(times_RP)

mean1(times_CP) 
mean1(times_CP) + 1.96*se_mean(times_CP)
mean1(times_CP) - 1.96*se_mean(times_CP)


mean1(times_UE) 
mean1(times_UE) + 1.96*se_mean(times_UE)
```

## Peace analysis for Experiment 1

We build the dataset for the peace analysis by referencing the list of connected players (`ndata1)`.

```{r, message = F, warning = F}
# PART 1
# Regenerate the individual peace status
data1 = data1 %>%
  mutate(peace_individual = ifelse(local_rate_punish_lag == 0 & 
                                     behavior_punish_lag == 0, 1, 0))

# Create the list of alters by superid
ndata_alters_list = ndata1 %>% 
  select(round, game, starts_with("id")) %>%
  filter(round != 0) %>%
  mutate(across(starts_with("id"), ~100*game+parse_number(.))) %>%
  rename(superid = id)

names(ndata_alters_list)[4:20] = c("alter1", "alter2", "alter3", "alter4", 
                                   "alter5", "alter6", "alter7", "alter8",
                                   "alter9", "alter10", "alter11", "alter12",
                                   "alter13", "alter14", "alter15", "alter16",
                                   "alter17")

ndata_alters_lag = ndata_alters_list
names(ndata_alters_lag)[4:20] = paste0("lag_",names(ndata_alters_lag)[4:20])
ndata_alters_lag$round = ndata_alters_lag$round+1

ndata_alters = merge(ndata_alters_list, ndata_alters_lag, 
                     by = c("superid", "round", "game")) %>%
  arrange(superid, round)

behaviors = data1 %>% 
  filter(round != 0) %>%
  select(superid, game, round, behavior_coop_lag, 
         behavior_punish_lag, behavior_defect_lag)

ndata_long_alters = ndata_alters %>%
  select(superid, round, game, starts_with("lag")) %>%
  pivot_longer(cols = starts_with("lag"), values_to = "alter_id") %>%
  filter(is.na(alter_id) == F)

pi_status = data1 %>% 
  select(superid, game, round, peace_individual, behavior_punish_lag)

punish_lag_status = data1 %>%
  select(superid, game, round, behavior_punish)

tdata_merged = ndata_long_alters %>%
  left_join(pi_status, by = c("superid", "round", "game")) %>%
  mutate(prev_round = round - 1) %>%
  left_join(punish_lag_status, 
            by = c("alter_id" = "superid", "game", "prev_round" = "round")) %>%
  rename(alter_punish_lag = behavior_punish)

tdata1 = tdata_merged %>%
  group_by(superid, round, game) %>%
  summarize(alter_punish_count = sum(alter_punish_lag)) %>%
  mutate(alter_punish_flag = ifelse(alter_punish_count == 0, 0, 1)) %>%
  left_join(pi_status, by = c("superid", "game", "round"))
```

```{r}
# given no punishing alters, 280/6655 decisions = 4.21% of followup decisions are made out of peace
# additionally, given presence of punishing alters, 104/1845 = 5.64% of followup decisions are made in peace
xtabs(~peace_individual + behavior_punish_lag + alter_punish_flag, tdata1)

prop.test(280, 6655)
prop.test(104, 1845)
# no punishers in previous round are in peace
xtabs(~behavior_punish_lag + peace_individual, data1)
sum(xtabs(~behavior_punish_lag + peace_individual, data1))

# individual peace proportion
prop.test(6518, 10727)
```

## 
