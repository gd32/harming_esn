---
title: "Punishment Subtypes Modeling"
author: "George Dewey"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse) # for data management
library(data.table) # for table management
library(reshape2) # for data management
library(magrittr) # for data management
library(lme4) # for mixed effects regression
library(lmerTest) # for p-values in regression output
library(reldist) # to calculate gini
library(rgeolocate) # to convert IPs to country
library(igraph) # for network analysis
library(gtable) # for visualization
library(grid) # for visualization
library(ggsignif) # for error bars
library(cowplot) # for visualization
library(gridExtra) # for visualization
library(reldist) # to calculate gini
library(sjPlot) # for tables
library(binom) # for generating confidence intervals
library(broom.mixed) # for mixed effects models output
library(kableExtra)

mean1 = function(x) {mean(x,na.rm=TRUE)}
median1 = function(x) {median(x, na.rm = TRUE)}
```

# Load data and preprocess

```{r}
#exp1
load("~/Documents/Projects/harming_esn/code/exp1/data1_pc.Rdata")
#exp2
load("~/Documents/Projects/harming_esn/code/exp2/tpdata_pc.Rdata")

tpdata_pc = tpdata_pc %>%
  mutate(behavior_punish = ifelse(behavior == "P" & is.na(behavior) == 0, 1, 0),
         behavior_coop = ifelse(behavior == "C" & is.na(behavior) == 0, 1, 0),
         behavior_defect = ifelse(behavior == "D" & is.na(behavior) == 0, 1, 0))

data_lag = tpdata_pc %>% select(superid, round, initial_score, payoff, 
                                    cumulativePayoff, cPayoffS, WealthLevel, 
                                    behavior_coop, local_rate_coop, 
                                    behavior_defect, local_rate_defect, 
                                    behavior_punish, local_rate_punish, 
                                  degree, happ, behaviorTime)
names(data_lag)[-c(1,2)] = paste0(names(data_lag)[-c(1,2)],"_lag")
data_lag$round = data_lag$round + 1
tpdata_pc = merge(x=tpdata_pc,y=data_lag,all.x=T,all.y=F,by=c("superid","round"))
```

## Model testing

```{r}
# logit model (crude)
m_test = glm(behavior_punish ~ tp_on, data = tpdata_pc)
tidy(m_test, conf.int = T, exponentiate = T) %>%
  rename(Term = term, Estimate = estimate, LL = conf.low, UL = conf.high, p = p.value) %>%
  select(Term, Estimate, LL, UL, p) %>%
  mutate(across(is.numeric, round, 4))
```

```{r}
# add age and gender to model
m_test2 = glm(behavior_punish ~ tp_on + gender + age, data = tpdata_pc)
summary(m_test2)
tidy(m_test2, conf.int = T) %>%
  rename(Term = term, Estimate = estimate, LL = conf.low, UL = conf.high, p = p.value) %>%
  select(Term, Estimate, LL, UL, p) %>%
  mutate(across(is.numeric, round, 4))
```

```{r}
# add round
m_test3 = glm(behavior_punish ~ tp_on + gender + age + factor(round), data = tpdata_pc)
tidy(m_test3, conf.int = T) %>%
  rename(Term = term, Estimate = estimate, LL = conf.low, UL = conf.high, p = p.value) %>%
  select(Term, Estimate, LL, UL, p) %>%
  mutate(across(is.numeric, round, 4)) 
```

```{r}
# use clustering w/ id
m_test4 = glmer(behavior_punish ~ tp_on + age + gender + factor(round) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

tidy(m_test4, conf.int = T) %>%
  rename(Term = term, Estimate = estimate, LL = conf.low, UL = conf.high, p = p.value) %>%
  select(Term, Estimate, LL, UL, p) %>%
  mutate(across(is.numeric, round, 4)) %>%
  head(4)
```

```{r}
# add game
m_test5 = glmer(behavior_punish ~ tp_on + age + gender + factor(round) + (1|superid) + (1|game), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

tidy(m_test5, conf.int = T) %>%
  rename(Term = term, Estimate = estimate, LL = conf.low, UL = conf.high, p = p.value) %>%
  select(Term, Estimate, LL, UL, p) %>%
  mutate(across(is.numeric, round, 4)) %>%
  head(4)
```

```{r}
# add game
m_test6 = glmer(behavior_punish ~ tp_on + factor(round) + (1|superid) + (1|game), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

tidy(m_test6, conf.int = T) %>%
  rename(Term = term, Estimate = estimate, LL = conf.low, UL = conf.high, p = p.value) %>%
  select(Term, Estimate, LL, UL, p) %>%
  mutate(across(is.numeric, round, 4)) %>%
  head(2)
```

## Experiment 1 Data - Models 8-11

To show the main effect of the experimental condition (either `showScore` or `tp_on`), we use a shortened model. We regress using Experiment 1 data for proof of concept.

### Model 8: All punishment in Exp. 1

```{r}
m8 = glmer(behavior_punish ~ showScore + age + gender + factor(round) + (1|game) + (1|superid), data = data1_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m8, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(4) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 9: IA in Exp. 1

```{r}
m9 = glmer(wealth_inequal ~ showScore + age + gender + factor(round) + (1|game) + (1|superid), data = data1_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m9, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(4) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 10: RP in Exp. 1

```{r}
m10 = glmer(reactive_p ~ showScore + age + gender + factor(round) + (1|game) + (1|superid), data = data1_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m10, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(4) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 11: UP in Exp. 1

```{r}
m11 = glmer(unexplained_p ~ showScore + age + gender + factor(round) + (1|game) + (1|superid), data = data1_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m11, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(4) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## Experiment 2 Data - Models 12-15

### Model 12: All punishment in Exp. 2

```{r}
m12 = glmer(behavior_punish ~ tp_on + factor(round) + (1|game) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

tidy(m12, conf.int=TRUE, exponentiate=T) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 13: IA in Exp. 2

```{r}
m13 = glmer(wealth_inequal ~ tp_on + factor(round) + (1|game) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m13, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 14: RP in Exp. 2

```{r}
m14 = glmer(reactive_p ~ tp_on + factor(round) + (1|game) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m14, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r}
tpdata_pc %>% 
  mutate(reactive_neg_p = case_when(wealth_inequal == 1 + ))

m14 = glmer(reactive_p ~ tp_on + factor(round) + (1|game) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m14, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r}
prop.test(c(370, 280), c(1629, 1580))
```


### Model 15: UP in Exp. 2

```{r}
m15 = glmer(unexplained_p ~ tp_on + factor(round) + (1|game) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m15, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 16: Cooperation in Exp. 2

```{r}
m16 = glmer(behavior_coop ~ tp_on + factor(round) + (1|game) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m16, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## Experiment 2 Models, Stratified by Gender

```{r}
# Subset the data
exp2m = tpdata_pc %>% filter(gender == "male")
exp2f = tpdata_pc %>% filter(gender == "female")
```

### Model 12m: All punishment in Exp. 2 - Males only

```{r}
m12m = glmer(behavior_punish ~ tp_on + factor(round) + (1|game) + (1|superid), data = exp2m, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m12m, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(3) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 12f: All punishment in Exp. 2 - Females only

```{r}
m12f = glmer(behavior_punish ~ tp_on + factor(round) + (1|game) + (1|superid), data = exp2f, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m12f, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(3) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 13m: IA in Exp. 2 - Males only

```{r}
m13m = glmer(wealth_inequal ~ tp_on + factor(round) + (1|game) + (1|superid), data = exp2m, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m13m, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(3) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 13f: IA in Exp. 2 - Females only

```{r}
m13f = glmer(wealth_inequal ~ tp_on + factor(round) + (1|game) + (1|superid), data = exp2f, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m13f, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(3) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 14m: RP in Exp. 2 - Males only

```{r}
m14m = glmer(reactive_p ~ tp_on + factor(round) + (1|game) + (1|superid), data = exp2m, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m14m, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(3) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 14f: RP in Exp. 2 - Females only

```{r}
m14f = glmer(reactive_p ~ tp_on + factor(round) + (1|game) + (1|superid), data = exp2f, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m14f, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(3) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 15m: UP in Exp. 2 - Males only

```{r}
m15m = glmer(unexplained_p ~ tp_on + factor(round) + (1|game) + (1|superid), data = exp2m, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m15m, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(3) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 15f: UP in Exp. 2 - Females only

```{r}
m15f = glmer(unexplained_p ~ tp_on + factor(round) + (1|game) + (1|superid), data = exp2f, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m15f, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(3) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## Create Table 1, 1a, 1b

### Table 1

```{r}
table1 = tibble(
  pun_type = c("All Punishment", "IA", "RP", "UP"),
  tp_off_percentage = c(373/1580, 171/1580, 200/1580, 106/1580),
  tp_on_percentage = c(239/1629, 141/1629, 102/1629, 58/1629),
  OR_tp = c("0.4602	(0.2601,	0.8142)", "1.4457	(0.5929, 3.5249)", "0.4498	(0.2113,	0.9574)", "0.4913	(0.2007,	1.2028)"),
  p = c(0.007, 0.4176, 0.0382, 0.1198),
)

table1 %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  kbl(col.names = c("Punishment Type", "% no TP", "% TP", "$OR_{TP}$ (95% CI)", "p")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```
