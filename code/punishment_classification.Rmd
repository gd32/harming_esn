---
title: "Classification of Punishment"
author: "George Dewey"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse) # for data management
library(patchwork)
```

# Classifying punishment into subtypes

We classify punishment into 3 main subtypes:

- inequality aversion: punishment to reduce perceived inequality
  - 3rd party punishment is a subclass of this: punishment to promote cooperation that is not reactive
- reactive: punishment in response to other punishment
- unexplained: punishment that is neither reactive nor inequality aversion

## Punishment classification for Experiment 1 data

```{r}
# 4 main datasets: 
# harmdata - cleaned raw individual-level data 
# ldata4 - tie component of network-level data
# ndata1 - node component of network-level data
# data1 - main aggregated dataset including lag (rounds t-1, t-2, etc.) data

rm(list = ls())

# harmdata
load("~/Documents/Projects/harming_esn/Data/harmdata.Rdata") #harmdata

# ldata4
load("~/Documents/Projects/harming_esn/Data/harming_jsons/ldata4_0316X.Rdata")

# ndata1
load("~/Documents/Projects/harming_esn/Data/raw/ndata_individual.Rdata")

# data1
load("~/Documents/Projects/harming_esn/Data/data1.Rdata") #data1

mean1 = function(x) {mean(x,na.rm=TRUE)}
median1 = function(x) {median(x, na.rm = TRUE)}

data1 = data1 %>%
  as_tibble()

dim(data1 %>% filter(behavior_punish == 1)) #562 punishments
```

## Punishment for inequality aversion 

We define this subtype of punishment as punishment that occurs when the wealth of the ego is less than the average wealth of alters.

```{r, message = F, warning = F}
# first, get the list of alters
ndata_alters_list = ndata1 %>% 
  select(round, game, starts_with("id")) %>%
  filter(round != 0) %>%
  mutate(across(starts_with("id"), ~100*game+parse_number(.))) %>%
  rename(superid = id)

names(ndata_alters_list)[4:20] = c("alter1", "alter2", "alter3", "alter4", 
                                   "alter5", "alter6", "alter7", "alter8",
                                   "alter9", "alter10", "alter11", "alter12",
                                   "alter13", "alter14", "alter15", "alter16",
                                   "alter17")

current_wealth = data1 %>% 
  filter(round != 0) %>%
  select(superid, game, round, cumulativePayoff, cPayoffS)

ndata_long_alters = ndata_alters_list %>%
  pivot_longer(cols = starts_with("alter"), values_to = ("alter_id")) %>%
  filter(is.na(alter_id) == 0)

ndata_long_alters_wealth = ndata_long_alters %>%
  left_join(current_wealth, by = c("round", "game", "alter_id" = "superid")) %>%
  group_by(superid, round, game) %>%
  summarize(mean_alter_wealth = mean1(cPayoffS))

data1_pc = data1 %>%
  left_join(ndata_long_alters_wealth, by = c("round", "game", "superid")) %>%
  mutate(wealth_inequal = ifelse(cPayoffS < mean_alter_wealth, 1, 0)) 
  
data1_pc %>%
  filter(behavior_punish == 1, round > 0) %>%
  group_by(wealth_inequal) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) %>%
  filter(is.na(wealth_inequal) == 0)

prop.test(x = c(270, 279), n = c(549, 549))
```

**49.6% wealth inequality vs 48% not due to wealth inequality**

## Reactive punishment

Punishment in response to punishment, defined as punishment after an alter punished in last round regardless of punishing alters' current ties (so this means the punishing alter no longer needs to be tied to the ego after rewiring).

```{r}
data1_pc = 
  data1_pc %>% 
  mutate(reactive_p = ifelse(behavior_punish == 1 & local_rate_punish_lag !=0, 1, 0))

data1_pc %>%
  filter(behavior_punish == 1) %>%
  mutate(reactive_p = ifelse(local_rate_punish_lag !=0, 1, 0)) %>%
  group_by(reactive_p) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) %>%
  filter(is.na(reactive_p) == 0)

prop.test(x = c(359, 149), n = c(508, 508))
```

**26.5% reactive, 63.9% not (54 NAs)**

## Unexplained punishments

Punishment that is not reactive or calculated.

```{r}
data1_pc_punishes = data1_pc %>%
  filter(behavior_punish == 1)

data1_pc_punishes %>%
  filter(round <= 1) #49

data1_pc_punishes %>%
  filter(round > 1 & wealth_inequal == 0 & reactive_p == 0) #171

# Cross tab
xtabs(~reactive_p + wealth_inequal, data1_pc_punishes)
```
# Calculating distribution of decision time by punishment status

## Inequality aversion

```{r}
# Statistics
data1_pc %>%
  mutate(behaviorTime_sec = behaviorTime/1000) %>%
  group_by(wealth_inequal) %>%
  filter(is.na(wealth_inequal) == F) %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            median_dt = median1(behaviorTime_sec),
            max_dt = max(behaviorTime_sec, na.rm = T),
            min_dt = min(behaviorTime_sec, na.rm = T),
            range_dt = range(behaviorTime_sec, na.rm = T))
```

```{r}
# Visual
pun1 = data1_pc %>%
  mutate(behaviorTime_sec = behaviorTime/1000) %>%
  na.omit() %>%
  filter(wealth_inequal %in% 0:1) %>%
  ggplot(aes(x = behaviorTime_sec, color = as.factor(wealth_inequal))) +
  geom_density(adjust = 2) + 
  scale_x_log10(limits = c(1, 110),breaks = c(1, 10, 100)) +
  scale_y_continuous(limits = c(0, 1.3)) +
  scale_color_manual(labels = c("Inequality Aversion", "Other"),
                     values = c("orange", "skyblue2")) +
    theme(axis.title = element_blank(),
        axis.text = element_text(size = rel(1.3)),
        legend.position = "right") +
  guides(colour=guide_legend(title = NULL))
```   
## Reactive punishment

```{r}
# Statistics
data1_pc %>%
  mutate(behaviorTime_sec = behaviorTime/1000) %>%
  group_by(reactive_p) %>%
  filter(is.na(reactive_p) == F) %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            median_dt = median1(behaviorTime_sec),
            max_dt = max(behaviorTime_sec, na.rm = T),
            min_dt = min(behaviorTime_sec, na.rm = T),
            range_dt = range(behaviorTime_sec, na.rm = T))
```

```{r}
# Visual
pun2 = data1_pc %>%
  mutate(behaviorTime_sec = behaviorTime/1000) %>%
  na.omit() %>%
  filter(reactive_p %in% 0:1) %>%
  ggplot(aes(x = behaviorTime_sec, color = as.factor(reactive_p))) +
  geom_density(adjust = 2) + 
  scale_x_log10(limits = c(1, 110),breaks = c(1, 10, 100)) +
  scale_y_continuous(limits = c(0, 1.3)) +
  scale_color_manual(labels = c("Reactive Punishment", "Other"),
                     values = c("magenta", "skyblue2")) +  
  theme(axis.title = element_blank(),
        axis.text = element_text(size = rel(1.3)),
        legend.position = "right") +
  guides(colour=guide_legend(title = NULL))
```   

## Unexplained punishment

```{r}
# Visual
pun3 = data1_pc %>%
  mutate(behaviorTime_sec = behaviorTime/1000,
         unexplained_p = ifelse(behavior_punish == 1 & reactive_p == 0 & wealth_inequal == 0, 1, 0)) %>%
  na.omit() %>%
  filter(unexplained_p %in% 0:1) %>%
  ggplot(aes(x = behaviorTime_sec, color = as.factor(unexplained_p))) +
  geom_density(adjust = 2) + 
  scale_x_log10(limits = c(1, 110),breaks = c(1, 10, 100)) +
  scale_y_continuous(limits = c(0, 1.3)) +
  scale_color_manual(labels = c("Unexplained Punishment", "Other"),
                     values = c("darkgreen", "skyblue2")) +
    theme(axis.title = element_blank(),
        axis.text = element_text(size = rel(1.3)),
        legend.position = "right") +
  guides(colour=guide_legend(title = NULL))
```   

## Combined figure

```{r}
# Create a 4-level variable: 1 = IA, 2 = Reactive, 3 = Unexpl., 4 = Other
data1_pc = data1_pc %>%
  mutate(
    behaviorTime_sec = behaviorTime/1000,
    unexplained_p = ifelse(behavior_punish == 1 & reactive_p == 0 & 
                             wealth_inequal == 0, 1, 0),
    pun_type = case_when(behavior_punish == 1 & wealth_inequal == 1 ~ 1,
                         behavior_punish == 1 & reactive_p == 1 ~ 2,
                         behavior_punish == 1 & unexplained_p == 1 ~ 3,
                         TRUE ~ 4))

# Combined fig. - exp 1
data1_pc %>% 
  na.omit() %>%
  ggplot(aes(x = behaviorTime_sec, color = as.factor(pun_type))) +
  geom_density(adjust = 2) + 
  scale_x_log10(limits = c(1, 110),breaks = c(1, 10, 100)) +
  scale_y_continuous(limits = c(0, 1.3)) +
  scale_color_manual(labels = c("IA", "RP", "UP", "Other"),
                     values = c("#FFBF00", "#DE1A1A", "#29BF12", "#00A5CF")) +
    theme(
        axis.text = element_text(size = rel(1.3)),
        legend.position = "right") +
  guides(colour=guide_legend(title = NULL))+
  xlab("Decision Time (s)") +
  ylab("Density") + 
  ggtitle("Distribution of decision times by punishment subtype - Exp. 1")
```

# Experiment 2 data

```{r}
load("~/Documents/Projects/harming_esn/data/exp2/ndata1_tp.Rdata")
load("~/Documents/Projects/harming_esn/data/exp2/ldata4_tp.Rdata")
load("~/Documents/Projects/harming_esn/data/exp2/tpdata.Rdata")

tpdata = tpdata %>%
  as_tibble()

tpdata %>%
  filter(behavior == "P") %>%
  dim() #612 punishments
```

## Instrumental punishment: punishing to reduce inequality defined as punishment that occurs when ego's wealth is lower than the mean wealth of alters

```{r}
# first, get the list of alters
ndata_alters_list = ndata_tp %>% 
  select(round, game, starts_with("id")) %>%
  filter(round != 0) %>%
  mutate(across(starts_with("id"), ~100*game+parse_number(.))) %>%
  rename(superid = id)

length(names(ndata_alters_list))

names(ndata_alters_list)[4:17] = c("alter1", "alter2", "alter3", "alter4", 
                                   "alter5", "alter6", "alter7", "alter8",
                                   "alter9", "alter10", "alter11", "alter12",
                                   "alter13", "alter14")

current_wealth = tpdata %>% 
  filter(round != 0) %>%
  select(superid, game, round, cumulativePayoff, cPayoffS)

ndata_long_alters = ndata_alters_list %>%
  pivot_longer(cols = starts_with("alter"), values_to = ("alter_id")) %>%
  filter(is.na(alter_id) == 0)

ndata_long_alters_wealth = ndata_long_alters %>%
  left_join(current_wealth, by = c("round", "game", "alter_id" = "superid")) %>%
  group_by(superid, round, game) %>%
  summarize(mean_alter_wealth = mean1(cPayoffS))

tpdata_pc = tpdata %>%
  left_join(ndata_long_alters_wealth, by = c("round", "game", "superid")) %>%
  mutate(wealth_inequal = ifelse(cPayoffS < mean_alter_wealth, 1, 0)) 

tpdata_pc %>%
  filter(round > 0) %>%
  group_by(behavior, tp_on) %>%
  filter(behavior %in% c("C", "D", "P")) %>%
  summarize(n=n()) %>%
  mutate(perc = n/sum(n),
         total = sum(n))
```

```{r}
prop.test(c(373, 239), c(1580, 1629))
```
```{r}
# logit model (crude)

m_test = glm(behavior_punish ~ tp_on, data = tpdata_pc)


# add age and gender to model
# 
# add round
# 
# use clustering w/ id
# 
# add game
# 
# 
```

```{r}
tpdata_pc %>%
  filter(behavior=="P", round > 0,is.na(wealth_inequal) == 0) %>%
  group_by(wealth_inequal) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n),
         total )

# checking p-value
prop.test(x = c(290, 312), n = c(290+312,  290+312))
```

**51.0% wealth inequality, 47.4% wealth equal**

## Reactive punishment: punishment in response to punishment defined as: punishment after an alter punished in last round

```{r}
tpdata_pc = 
  tpdata_pc %>% 
  mutate(reactive_p = ifelse(behavior == "P" & prev_local_rate_punish!=0, 1, 0))

tpdata_pc %>%
  filter(behavior == "P") %>%
  group_by(reactive_p) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n))

prop.test(c(310, 302), c(612, 612))
```
**49.3% reactive, 50.7% not**

```{r}
# 3rd party punishment - i.e.; reactive_p = 0 + wealth_inequal = 1

tpdata_pc %>%
  filter(behavior == "P") %>%
  group_by(reactive_p, wealth_inequal) %>%
  summarize(n= n()) %>%
  filter(is.na(wealth_inequal) == 0) %>%
  ungroup() %>%
  mutate(perc = n/sum(n))

# 23.3%?
```


## Unexplained punishments - not reactive or calculated

```{r}
tpdata_pc %>%
  filter(behavior == "P" & round <= 1) %>%
  dim()

tpdata_pc %>%
  filter(behavior == "P" & round > 1 & wealth_inequal == 0 & reactive_p == 0) %>%
  dim() 
```

```{r}
# crosstabs
xtabs(~wealth_inequal + reactive_p, tpdata_pc %>% filter(round > 1, behavior == "P"))

# tp_labels = read_csv("~/Documents/Projects/breadboard/time_pressure_brb/Assignment/tp_assignment.csv")
# tp_on = tp_labels %>% filter(time_pressure_on == 1) %>% select(game) %>% pull()
# 
# tpdata_pc = tpdata_pc %>%
#   mutate(time_pressure = ifelse(game %in% tp_on, 1, 0))

xtabs(~time_pressure+wealth_inequal, tpdata_only_p)
xtabs(~time_pressure+reactive_p, tpdata_only_p)

tpdata_pc %>%
  group_by(tp_on, behavior) %>%
  filter(behavior %in% c("C", "D", "P")) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n),
         total = sum(n))
```

```{r}
# p-values
# for C
prop.test(x = c(837, 706), n = c(1580, 1629)) # p < 0.0001

# for D
prop.test(x = c(379, 684), n = c(1580, 1629)) # p < 0.0001

# for P
prop.test(x = c(373, 239), n = c(1580, 1629)) # p < 0.0001
```

```{r}
tpdata_pc %>%
  group_by(tp_on, behavior, wealth_inequal) %>%
  filter(behavior %in% c("C", "D", "P"), is.na(wealth_inequal) == 0) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n),
         total = sum(n)) %>%
  filter(wealth_inequal == 1)

171/1580 # tp off
141/1629 # tp on

prop.test(c(171, 141), c(1580, 1629))
```

```{r}
tpdata_pc %>%
  group_by(tp_on, behavior, reactive_p) %>%
  filter(behavior %in% c("C", "D", "P"), is.na(reactive_p) == 0) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n),
         total = sum(n)) %>%
  filter(reactive_p == 1)

200/1580
102/1629

prop.test(c(200, 102), c(1580, 1629))
```

```{r}
tpdata_pc %>%
  group_by(tp_on, behavior, wealth_inequal, reactive_p) %>%
  filter(behavior %in% c("C", "D", "P"), is.na(wealth_inequal) == 0, is.na(reactive_p) == 0) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n),
         total = sum(n)) %>%
  filter(wealth_inequal == 0 & reactive_p == 0)

106/1580 #6.71
58/1629 #3.56

prop.test(c(106, 56), c(1580, 1629))
```

# Distributions of decision time

## Combined figure

```{r, message = F, warning = F}
# Create a 4-level variable: 1 = IA, 2 = Reactive, 3 = Unexpl., 4 = Other
# here, we need 2 datasets - one for TP on, one for TP off

tpdata_tpon = tpdata_pc %>%
  filter(tp_on == 1) %>%
  mutate(
    behaviorTime_sec = behaviorTime/1000,
    unexplained_p = ifelse(behavior == "P" & reactive_p == 0 & 
                             wealth_inequal == 0, 1, 0),
    pun_type = case_when(behavior == "P" & wealth_inequal == 1 ~ 1,
                         behavior == "P" & reactive_p == 1 ~ 2,
                         behavior == "P" & unexplained_p == 1 ~ 3,
                         TRUE ~ 4))

tpdata_tpoff = tpdata_pc %>%
  filter(tp_on == 0) %>%
  mutate(
    behaviorTime_sec = behaviorTime/1000,
    unexplained_p = ifelse(behavior == "P" & reactive_p == 0 & 
                             wealth_inequal == 0, 1, 0),
    pun_type = case_when(behavior == "P" & wealth_inequal == 1 ~ 1,
                         behavior == "P" & reactive_p == 1 ~ 2,
                         behavior == "P" & unexplained_p == 1 ~ 3,
                         TRUE ~ 4))
```

```{r}
# Combined fig. - exp 2 (tp on)
tpdata_tpon %>% 
  na.omit() %>%
  ggplot(aes(x = behaviorTime_sec, color = as.factor(pun_type))) +
  geom_density(adjust = 2) + 
  scale_x_log10(limits = c(1, 110),breaks = c(1, 10, 100)) +
  scale_y_continuous(limits = c(0, 2)) +
  scale_color_manual(labels = c("IA", "RP", "UP", "Other"),
                     values = c("#FFBF00", "#DE1A1A", "#29BF12", "#00A5CF")) +
    theme(
        axis.text = element_text(size = rel(1.3)),
        legend.position = "right") +
  guides(colour=guide_legend(title = NULL))+
  xlab("Decision Time (s)") +
  ylab("Density") + 
  ggtitle("Distribution of decision times by punishment subtype - Exp. 2 (TP on)")
```

```{r}
# Combined fig. - exp2 (tp off)
tpdata_tpoff %>% 
  na.omit() %>%
  ggplot(aes(x = behaviorTime_sec, color = as.factor(pun_type))) +
  geom_density(adjust = 2) + 
  scale_x_log10(limits = c(1, 110),breaks = c(1, 10, 100)) +
  scale_y_continuous(limits = c(0, 2)) +
  scale_color_manual(labels = c("IA", "RP", "UP", "Other"),
                     values = c("#FFBF00", "#DE1A1A", "#29BF12", "#00A5CF")) +
    theme(
        axis.text = element_text(size = rel(1.3)),
        legend.position = "right") +
  guides(colour=guide_legend(title = NULL))+
  xlab("Decision Time (s)") +
  ylab("Density") + 
  ggtitle("Distribution of decision times by punishment subtype - Exp. 2 (TP off)")
```
It looks like time pressure reduced punishment across the board - both sys1 and sys2 types of punishment were dramatically reduced.

## Punishment subtypes stratified by gender

### Females only

```{r}
# All punishment
tpdata_pc %>%
  group_by(tp_on, behavior) %>%
  filter(behavior %in% c("C", "D", "P"), 
         gender == "female") %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n),
         total = sum(n))

84/514
78/563

prop.test(c(84, 78), c(514, 563)) #p = 0.29
```

```{r}
# IA
tpdata_pc %>%
  group_by(tp_on, behavior, wealth_inequal) %>%
  filter(behavior %in% c("C", "D", "P"), 
         is.na(wealth_inequal) == 0,
         gender == "female") %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n),
         total = sum(n)) %>%
  filter(wealth_inequal == 1) 

53/514 # tp off
57/563 # tp on

prop.test(c(53, 57), c(514, 563)) # p = 0.9996
```

```{r}
# RP
tpdata_pc %>%
  group_by(tp_on, behavior, reactive_p) %>%
  filter(behavior %in% c("C", "D", "P"), 
         is.na(reactive_p) == 0,
         gender == "female") %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n),
         total = sum(n)) %>%
  filter(reactive_p == 1) 

60/514 # tp off
33/563 # tp on

prop.test(c(60, 33), c(514, 563)) # p = 0.001
```

```{r}
# UP
tpdata_pc %>%
  group_by(tp_on, behavior, wealth_inequal, reactive_p) %>%
  filter(gender == "female", 
         behavior %in% c("C", "D", "P"),
         is.na(wealth_inequal) == 0, is.na(reactive_p) == 0) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n),
         total = sum(n)) %>%
  filter(wealth_inequal == 0 & reactive_p == 0)

12/514 # tp off
13/563 # tp on

prop.test(c(12, 13), c(514, 563)) # p = 1
```

```{r}
# Table 1a - Females only
library(kableExtra)

table1a = tibble(
  pun_type = c("All", "IA", "RP", "UP"),
  tp_off = c(0.163, 0.103, 0.167, 0.023),
  tp_on = c(0.139, 0.101, 0.059, 0.023),
  p = c(0.29, 0.999, 0.001, 1)
)

table1a %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Males only

```{r}
tpdata_pc %>%
  group_by(tp_on, behavior) %>%
  filter(behavior %in% c("C", "D", "P"), 
         gender == "male") %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n),
         total = sum(n))

152/635 #tp_off: 0.132
83/453 #tp_on: 0.172

prop.test(c(84, 78), c(635, 453)) #p = 0.083
```

```{r}
tpdata_pc %>%
  group_by(tp_on, behavior, wealth_inequal) %>%
  filter(behavior %in% c("C", "D", "P"), 
         is.na(wealth_inequal) == 0,
         gender == "male") %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n),
         total = sum(n)) %>%
  filter(wealth_inequal == 1) 

60/635 # tp off-0.094
38/453 # tp on-0.084

prop.test(c(60, 38), c(635, 453)) # p = 0.621
```

```{r}
tpdata_pc %>%
  group_by(tp_on, behavior, reactive_p) %>%
  filter(behavior %in% c("C", "D", "P"), 
         is.na(reactive_p) == 0,
         gender == "male") %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n),
         total = sum(n)) %>%
  filter(reactive_p == 1) 

82/635 # tp off -0.129
41/453 # tp on -0.091

prop.test(c(82, 41), c(635, 453)) # p = 0.059
```

```{r}
tpdata_pc %>%
  group_by(tp_on, behavior, wealth_inequal, reactive_p) %>%
  filter(gender == "male", 
         behavior %in% c("C", "D", "P"),
         is.na(wealth_inequal) == 0, is.na(reactive_p) == 0) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n),
         total = sum(n)) %>%
  filter(wealth_inequal == 0 & reactive_p == 0)

49/635 # tp off -0.077
24/453 # tp on -0.053

prop.test(c(49, 24), c(635, 453)) # p = 0.147
```

```{r}
# Table 1b - Males only
table1b = tibble(
  pun_type = c("All", "IA", "RP", "UP"),
  tp_off = c(0.132, 0.094, 0.129, 0.077),
  tp_on = c(0.172, 0.083, 0.091, 0.053),
  p = c(0.083, 0.621, 0.059, 0.147)
)

table1b %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

