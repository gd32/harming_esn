---
title: "Analysis for Harming Behaviors"
author: "George Dewey"
date: "`r Sys.Date()`"
output: html_document
---

This document will go through the analysis of punishment behavior and related patterns in two network-based social experiments. 

Notes: This document will be an updated version of the document previously worked on titled "Evolution of Peace in Experimental Social Networks".


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Summary of Previous Work and Objectives

Previously, our analysis resulted in two main findings: 1) that decision time and type of behavior are related, where choosing punishment results in longer decision times compared to either non-punishing (cooperation or defection) behavior and 2) that there is a threshold in players' local network, that when exceeded, results in a higher propensity to choose to punish.

The objective of this document is to concretely establish the validity of finding 1 and to further explore the mechanisms resulting in finding 2).

## Load data and packages

```{r, message = F, warning = F}
mean1 = function(x) {mean(x, na.rm = TRUE)}

library(tidyverse)
library(lme4)
library(magrittr)
library(igraph)

load("~/Documents/Projects/harming_esn/Data/harmdata.Rdata") #harmdata
load("~/Documents/Projects/harming_esn/Data/harming_jsons/ldata4_0316X.Rdata") #ldata4
load("~/Documents/Projects/harming_esn/Data/ndata_individual.Rdata") #ndata1
load("~/Documents/Projects/harming_esn/Data/data1.Rdata") #data1
```

## Show distriubtion of decision time

```{r}
# Isolate the time data
dt_data = data1 %>%
  group_by(superid) %>%
  summarize(mean_dt = mean1(behaviorTime),
            mean_log_dt = mean1(log(behaviorTime)))

# Filter decision times by behavior type and merge
dt_coop = data1 %>%
  group_by(superid) %>%
  filter(behavior_coop == 1) %>%
  summarize(mean_dt_coop = mean1(behaviorTime),
            mean_log_dt_coop = mean1(log(behaviorTime)))

dt_def = data1 %>%
  group_by(superid) %>%
  filter(behavior_defect == 1) %>%
  summarize(mean_dt_defect = mean1(behaviorTime),
            mean_log_dt_defect = mean1(log(behaviorTime)))

dt_punish = data1 %>%
  group_by(superid) %>%
  filter(behavior_punish == 1) %>%
  summarize(mean_dt_punish = mean1(behaviorTime),
            mean_log_dt_punish = mean1(log(behaviorTime)))

dt_non_punish = data1 %>%
  group_by(superid) %>%
  filter(behavior_punish == 0) %>%
  summarize(mean_dt_nonpunish = mean1(behaviorTime),
            mean_log_dt_nonpunish = mean1(log(behaviorTime)))

dt_data_by_behavior = left_join(dt_coop, dt_def, by = "superid") %>%
  left_join(dt_punish, by = "superid") %>%
  left_join(dt_non_punish, by = "superid")

```

```{r}
# Show distribution of all decision times
dt_data %>% 
  ggplot() +
  geom_histogram(aes(x = mean_log_dt), binwidth = 0.25) +
  xlab("log Decision Time (s)")+
  ylab("Frequency")
```

```{r}
# Show distribution of decision times for punish/non-punish, aggregated by individual

## Punish times
dt_data_by_behavior %>%
  ggplot() +
  geom_density(aes(x = mean_log_dt_punish)) +
  xlab("log Decision Time (s)")+
  ylab("Frequency")

## Nonpunish times
dt_data_by_behavior %>%
  ggplot() +
  geom_density(aes(x = mean_log_dt_nonpunish)) +
  xlab("log Decision Time (s)") +
  ylab("Density")


## Together
dt_data_by_behavior %>%
  ggplot() +
  geom_density(aes(x = mean_log_dt_punish, y = ..scaled..), color = "orange") +
  geom_density(aes(x = mean_log_dt_nonpunish, y = ..scaled..), color = "blue")+
  xlab("log seconds")+
  ylab("Density") 
```

```{r}
# Show distribution of the difference between punish and nonpunish choices, by individual (paired differences)
dt_data_by_behavior %>% 
  select(mean_log_dt_punish, mean_log_dt_nonpunish) %>%
  mutate(dt_diff = mean_log_dt_punish - mean_log_dt_nonpunish) %>%
  filter(is.na(dt_diff) == 0) %>%
  ggplot() +
  geom_histogram(aes(x = dt_diff)) +
  xlab("Difference in decision time (punish - nonpunish)") +
  ylab("Frequency")
```

## Understanding behavioral contributions to peace

```{r}
#### Network Analysis for Peace

## We define peace as having no punishment in at least 5 (or 3?) consecutive rounds

#### Part 1 - Game level analysis ####
# First checking how many rounds have a punishment choice
peace_rounds = NULL
punish_rounds = NULL
for(i in 1:50){
  tmp = harmdata %>% filter(game == i, round !=0) %>% group_by(round) %>% 
    tally(behavior_punish) %>% group_by(n) %>% summarize(round_count = n())
  peace_rounds = c(peace_rounds, 
                   sum(tmp %>% filter(n == 0) %>% pull(round_count)))
  punish_rounds = c(punish_rounds, 
                    sum(tmp %>% filter(n != 0) %>% pull(round_count)))
}
sum(peace_rounds) #377 rounds with no punish choice
sum(punish_rounds) #373 rounds with at least 1 punish choice

## The balance between peaceful and non-peaceful rounds is evident. Makes sense given the small range of behavioral choices? (need to find theory??)

tmp = harmdata %>% filter(game == 1, round !=0) %>% group_by(round) %>% tally(behavior_punish) %>% pull(n)

subseq_check <- function(x,y) grepl(toString(y),toString(x),fixed = TRUE)
subseq_check(tmp, c("0", "0", "0", "0", "0"))
peace_str = c("0", "0", "0", "0", "0")

tmp = c(1, 2, 3, 4, 5)

peace_games = NULL
war_games = NULL
for(i in 1:50){
  tmp = harmdata %>% filter(game == i, round !=0) %>% group_by(round) %>% 
    tally(behavior_punish) %>% pull(n)
  if(subseq_check(tail(tmp, 5), peace_str) == T){
    peace_games = c(peace_games, i)
  } else {
    war_games = c(war_games, i)
  }
}
```

```{r}
length(peace_games) #14 games had peace (last 5 rounds had no punishment)
```

## Create a heatmap for the number of punishments in each round of peaceful games

```{r}
punish_counts = NULL
for(i in peace_games){
  tmp = harmdata %>% filter(game == i, round !=0) %>% group_by(round) %>% 
    tally(behavior_punish) %>% pull(n)
  punish_counts = cbind(punish_counts, tmp)
}
punish_counts = as.data.frame(punish_counts)
names(punish_counts) = as.numeric(as.character(peace_games))

punish_counts %>%
  rownames_to_column() %>%
  gather(colname, value, -rowname) %>%
  ggplot(aes(x = as.numeric(rowname), y = colname, fill = value)) +
  geom_tile() +
  xlab("Round") + ylab("Game ID")
```

# Calculate the number of punishments per game and create a visual (originally heatmap_behavior.R)

```{r}
# get the number of punishments per game
pun_counts = harmdata %>% 
  group_by(game) %>%
  tally(behavior_punish) %>%
  rename(punishments = n)

# get the number of punishments per game by round
harmdata %>%
  group_by(game, round) %>%
  tally(behavior_punish)
```

```{r}
names(harmdata)
```

```{r}
netdata = harmdata %>% 
  group_by(game) %>%
  select(superid, game, round, showScore, behavior_coop, behavior_defect, 
         behavior_punish, payoff, behaviorTime, degree, rate_rich, 
         local_gini, initial_coop, initial_defect, initial_punish, initial_local_gini, 
         initial_degree, happ, WealthLevel,PosWealth, country) %>%
  arrange(game, round, superid) %>%
  mutate(peace_game = ifelse(game %in% peace_games, 1, 0))  %>%
  summarize(showScore = mean(showScore),
            n = n(),
            mean_deg = mean1(degree),
            mean_init_deg = mean1(initial_degree),
            mean_behaviorTime = mean1(behaviorTime),
            mean_payoff = mean1(payoff),
            sum_cum_payoff = sum(payoff, na.rm = T),
            prop_punish = mean1(behavior_punish),
            sum_punish = sum(behavior_punish),
            prop_coop = mean1(behavior_coop),
            sum_coop = sum(behavior_coop),
            init_coop = mean1(initial_coop),
            init_punish = mean1(initial_punish),
            mean_gini = mean1(initial_local_gini),
            mean_posWealth = mean1(PosWealth),
            peace_game = mean1(peace_game))

netdata1 = left_join(netdata, pun_counts, by = "game")


```

## Understanding what this aggregate dataframe `netdata` is

```{r}
# Netdata is the data aggregated at the game level 
# numeric values are averaged across rounds by game
# what other aggregate data can I use?

# Regressions are thus aggregations of aggregations - viable?

netdata
```

## Regression models using the aggregate data

```{r}
## Model 0 - wealth visibility only
m0 = glm(peace_game ~ showScore, data = netdata)
summary(m0)

# Question - why are peace and wealth visibility related?

xtabs(~peace_game + showScore, netdata) # peaceful games are mostly invisible wealth
```

## What factors link peaceful games (i.e. waning of punishment frequency in later rounds) to wealth visibilty?

```{r}
# Degree measures
m1.1 = glm(peace_game ~ showScore + mean_deg +  mean_init_deg, data = netdata1)
summary(m1.1)
```
```{r}
netdata1
m1_full = glm(peace_game ~ showScore + mean_deg +  mean_init_deg + mean_behaviorTime + mean_payoff + sum_cum_payoff + prop_punish + prop_coop + sum_punish + sum_coop + init_punish + init_coop + mean_gini + mean_posWealth, data = netdata1)

summary(m1_full) # only prop_punish; more punish -> less peace. makes sense.
```

```{r}
# only the behavior measures
m1.2 = glm(peace_game ~ showScore + prop_punish + prop_coop + sum_punish + sum_coop + init_punish + init_coop, data = netdata)
summary(m1.2)
```

```{r}
m1.3 = glm(peace_game ~ showScore + mean_deg + mean_gini + mean_init_deg, data = netdata)
summary(m1.3)
```

## What are the characteristics of the peaceful and nonpeaceful games?

Here we show the bivariate comparisons for each parameter and the # of punishments (since that is the best predictor for non-peace games).

```{r}
all_games = 1:50
non_peace_games = all_games[!all_games %in% peace_games]
peace_games

names(netdata1)
peace_games_df = netdata1 %>% filter(game %in% peace_games) %>% arrange(desc(sum_punish))
war_games_df = netdata1 %>% filter(game %in% non_peace_games) %>% arrange(desc(sum_punish))
```

```{r}
netdata1 = netdata1 %>%
  mutate(peace_game = game %in% peace_games,
         log_mean_time = log(mean_behaviorTime))

names(netdata1)
```

```{r}
# Number of obs
netdata1 %>%
  ggplot(aes(x=n, y=punishments)) + 
  geom_point(aes(color = peace_game)) +
  geom_smooth(aes(group = peace_game, color = peace_game), 
              method = "lm", 
              se = FALSE) +
  scale_color_brewer(palette = "Paired")
```
```{r}
# Log decision time
netdata1 %>%
  ggplot(aes(x=log_mean_time, y = punishments)) + 
  geom_point(aes(color = peace_game)) +
  geom_smooth(aes(group = peace_game, color = peace_game), 
              method = "lm", 
              se = FALSE) +
  scale_color_brewer(palette = "Paired")
```


```{r}
# Mean degree (all rounds)
netdata1 %>%
  ggplot(aes(x=mean_deg, y = punishments)) + 
  geom_point(aes(color = peace_game)) +
  geom_smooth(aes(group = peace_game, color = peace_game), 
              method = "lm", 
              se = FALSE) +
  scale_color_brewer(palette = "Paired")
```


```{r}
# Initial degree
netdata1 %>%
  ggplot(aes(x=mean_init_deg, y = punishments)) + 
  geom_point(aes(color = peace_game)) +
  geom_smooth(aes(group = peace_game, color = peace_game), 
              method = "lm", 
              se = FALSE) +
  scale_color_brewer(palette = "Paired")
```

```{r}
# mean payoff x 10^9
netdata1 %>%
  ggplot(aes(x=mean_payoff*1e9, y = punishments)) + 
  geom_point(aes(color = peace_game)) +
  geom_smooth(aes(group = peace_game, color = peace_game), 
              method = "lm", 
              se = FALSE) +
  scale_color_brewer(palette = "Paired")
```

```{r}
# total payoff
netdata1 %>%
  ggplot(aes(x=sum_cum_payoff, y = punishments)) + 
  geom_point(aes(color = peace_game)) +
  geom_smooth(aes(group = peace_game, color = peace_game), 
              method = "lm", 
              se = FALSE) +
  scale_color_brewer(palette = "Paired")

```
```{r}
# initial punish proportion
netdata1 %>%
  ggplot(aes(x=init_punish, y = punishments)) + 
  geom_point(aes(color = peace_game)) +
  geom_smooth(aes(group = peace_game, color = peace_game), 
              method = "lm", 
              se = FALSE) +
  scale_color_brewer(palette = "Paired")
```
```{r}
# initial coop proportion
netdata1 %>%
  ggplot(aes(x=init_coop, y = punishments)) + 
  geom_point(aes(color = peace_game)) +
  geom_smooth(aes(group = peace_game, color = peace_game), 
              method = "lm", 
              se = FALSE) +
  scale_color_brewer(palette = "Paired")
```
```{r}
# mean gini
netdata1 %>%
  ggplot(aes(x=mean_gini, y = punishments)) + 
  geom_point(aes(color = peace_game)) +
  geom_smooth(aes(group = peace_game, color = peace_game), 
              method = "lm", 
              se = FALSE) +
  scale_color_brewer(palette = "Paired")
```

```{r}
# mean Wealth
netdata1 %>%
  ggplot(aes(x=mean_posWealth, y = punishments)) + 
  geom_point(aes(color = peace_game)) +
  geom_smooth(aes(group = peace_game, color = peace_game), 
              method = "lm", 
              se = FALSE) +
  scale_color_brewer(palette = "Paired")
```