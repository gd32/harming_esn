---
title: "Data Analysis"
author: "George Dewey, Hiroyasu Ando, Ryo Ikesu, Akihiro Nishi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This R Markdown document contains the data analysis and visualization code for the Main Text of our article, ***Spontaneous Peacebuilding and Calculated Harming***. For other analyses and figures, please refer to the Supplementary Materials attachment.

# Load data

```{r}
# Experiment 1 data
load("~/Documents/Projects/harming_esn/code/exp1/data1_pc_v2.Rdata") 

# Experiment 2 data
exp2data = read_csv("~/Documents/Projects/harming_esn/data/exp2/exp2data_complete.csv", show_col_types = F)

# Experiment 3 data
load("~/Documents/Projects/harming_esn/data/exp3/exp3data_pc_v2.Rdata")
```

# Load helper functions

```{r}
mean1 = function(x) {mean(x,na.rm=TRUE)}
median1 = function(x) {median(x, na.rm = TRUE)}
sd1 = function(x) {sd(x, na.rm = TRUE)}
se_mean = function(x) sd1(x)/sqrt(sum(is.na(x) == 0))
```

# Load packages

```{r, message = F, warning = F}
library(tidyverse)
library(igraph)
library(lme4)
library(lmerTest)
library(data.table)
library(broom.mixed)
library(patchwork)
library(stringr)
```

# Results

## Experiment 1 - Descriptive Statistics

```{r}
# Number of actions
dim(data1_pc)[1] #10727 recorded actions
```

```{r}
# Number of players
length(unique(data1_pc$superid)) #745 unique participants 
```

```{r}
# Players per game, min, max
data1_pc %>%
  group_by(game) %>%
  select(superid) %>%
  unique() %>%
  summarize(n = n()) %>%
  summarize(mean_players = mean(n),
            min_players = min(n),
            max_players = max(n))
```

```{r}
# Behavior breakdown
data1_pc %>%
  mutate(behavior = case_when(behavior_coop == 1 ~ "C",
                              behavior_defect == 1 ~ "D",
                              behavior_punish == 1 ~ "P")) %>%
  group_by(behavior) %>%
  filter(behavior %in% c("C", "D", "P")) %>%
  summarize(n = n()) %>%
  mutate(perc = round(n/10727, 4))


```

```{r}
# CIs for proportions
prop.test(4878, 10727)
prop.test(4336, 10727)
prop.test(562, 10727)
```

```{r}
# Network statistics
mean1(data1$degree)
mean1(data1$transitivity)
```

```{r}
# Times per behavior
data1_pc = data1_pc %>% mutate(behavior = case_when(behavior_coop == 1 ~ "C",
                              behavior_defect == 1 ~ "D",
                              behavior_punish == 1 ~ "P"))
data1_behavior_times = data1_pc %>%
  group_by(behavior) %>%
  filter(behavior %in% c("C", "D", "P")) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = se_mean(behaviorTime/1000))

fig1data1 = tibble(
  behavior = c("C", "D", "P"),
  count = c(4878, 4336, 562),
  total = c(10727, 10727, 10727)
)

fig1data1 = fig1data1 %>%
  left_join(data1_behavior_times, by = "behavior")

fig1data1 = fig1data1 %>%
  mutate(prop = count/total,
         se_count = sqrt(prop*(1-prop)/total))

data1_behavior_times
```
```{r}
data1_pc %>%
  group_by(behavior)
  filter(behavior %in% c("C", "D", "P")) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = se_mean(behaviorTime/1000))

```

```{r}
# Punishment subtypes
data1_pc = data1_pc %>% 
  mutate(costly_punish = ifelse(behavior_punish == 1 & local_rate_coop_lag < 0.5, 1, 0),
         unexplained_p = ifelse(behavior_punish == 1 & wealth_inequal == 0 & retaliation_harm == 0 &
                                costly_punish == 0, 1, 0),
         inequality_averse_neg = ifelse(behavior == "P" & wealth_inequal == 0, 1, 0),
         retaliation_neg = ifelse(behavior == "P" & retaliation_harm == 0, 1, 0),
         costly_pun_neg = ifelse(behavior == "P" & costly_punish == 0, 1, 0)) 
```

```{r}
fig1data2 = tibble(
  harm_type_base = c("RE", "RE", "CE", "CE", "IA", "IA"),
  pos_neg = c(rep(c("+", "-"), 3)),
  count = c(143, 419, 307, 255, 143, 419),
  total = rep(562, 6)
)

fig1data2 = fig1data2 %>%
  mutate(prop = count/total,
         se_count = sqrt(prop*(1-prop)/total))
```

```{r}
data1_pc %>%
  group_by(retaliation_harm) %>%
  summarize(n = n()) #143
```

```{r}
data1_pc %>%
  group_by(retaliation_neg) %>%
  summarize(n = n()) #307
```

```{r}
data1_pc %>%
  group_by(costly_punish) %>%
  summarize(n = n()) #307
```

```{r}
data1_pc %>%
  filter(behavior_punish == 1, showScore == 1) %>%
  group_by(wealth_inequal) %>%
  summarize(n = n()) # 279
```

```{r}
times_ia_plus_exp1 = data1_pc %>%
  filter(wealth_inequal == 1, behavior_punish == 1) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type_base = "IA",
         pos_neg = "+") %>%
  select(harm_type_base, pos_neg, mean_dt, se_mean_dt)
```

```{r}
times_ia_minus_exp1 = data1_pc %>%
  filter(inequality_averse_neg == 1, behavior_punish == 1) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type_base = "IA",
         pos_neg = "-") %>%
  select(harm_type_base, pos_neg, mean_dt, se_mean_dt)
```

```{r}
times_re_plus_exp1 = data1_pc %>%
  filter(retaliation_harm == 1, behavior_punish == 1) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type_base = "RE",
         pos_neg = "+") %>%
  select(harm_type_base, pos_neg, mean_dt, se_mean_dt)
```

```{r}
times_re_minus_exp1 = data1_pc %>%
  filter(retaliation_neg == 1, behavior_punish == 1) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type_base = "RE",
         pos_neg = "-") %>%
  select(harm_type_base, pos_neg, mean_dt, se_mean_dt)
```

```{r}
times_ce_plus_exp1 = data1_pc %>%
  filter(costly_punish == 1, behavior_punish == 1) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type_base = "CE",
         pos_neg = "+") %>%
  select(harm_type_base, pos_neg, mean_dt, se_mean_dt)
```

```{r}
times_ce_minus_exp1 = data1_pc %>%
  filter(costly_pun_neg == 1, behavior_punish == 1) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type_base = "CE",
         pos_neg = "-") %>%
  select(harm_type_base, pos_neg, mean_dt, se_mean_dt)
```

```{r}
fig1_times_subtypes = bind_rows(times_re_plus_exp1, times_re_minus_exp1, times_ce_plus_exp1, times_ce_minus_exp1, times_ia_plus_exp1, times_ia_minus_exp1)

fig1data2 = fig1data2 %>% 
  left_join(fig1_times_subtypes, by = c("harm_type_base", "pos_neg"))
```

### Sensitivity Analysis 1 - Differences in Decision Times, using log-transformed time

```{r}
data1 %>%
  mutate(behavior = case_when(behavior_coop == 1 ~ "C",
                              behavior_defect == 1 ~ "D",
                              behavior_punish == 1 ~ "P"),
         behaviorTime_sec = behaviorTime/1000) %>%
  group_by(behavior) %>%
  filter(behavior %in% c("C", "D", "P")) %>%
  summarize(mean_dt = mean1(log_behaviorTime))

# Calculating SEs
log_times_coop = data1 %>% filter(behavior_coop == 1) %>% dplyr::select(log_behaviorTime) %>% pull()
log_times_defect = data1 %>% filter(behavior_defect == 1) %>% dplyr::select(log_behaviorTime) %>% pull()
log_times_punish = data1 %>% filter(behavior_punish == 1) %>% dplyr::select(log_behaviorTime) %>% pull()

se_mean = function(x) sd(x)/sqrt(length(x))

mean1(log_times_coop)
round(mean1(log_times_coop)+ 1.96*se_mean(log_times_coop), 2)
round(mean1(log_times_coop)- 1.96*se_mean(log_times_coop), 2)

mean1(log_times_defect)
round(mean1(log_times_defect)+ 1.96*se_mean(log_times_defect), 2)
round(mean1(log_times_defect)- 1.96*se_mean(log_times_defect), 2)

mean1(log_times_punish)
round(mean1(log_times_punish)+ 1.96*se_mean(log_times_punish), 2)
round(mean1(log_times_punish)- 1.96*se_mean(log_times_punish), 2)
```

```{r}
t.test(log_times_coop, log_times_defect) # p = 0.00026
t.test(log_times_coop, log_times_punish) # p < 0.0001
t.test(log_times_defect, log_times_punish) #p < 0.0001
```

On the log scale, the T-tests remain significant for all of the comparisons and no confidence intervals overlap.

### Sensitivity Analysis 2 - Adjusting the criteria for cooperation-enforcing harming

```{r}
data1_pc_sa2 = data1_pc %>%
    mutate(costly_punish_a = ifelse(behavior_punish == 1 & local_rate_coop_lag < 0.45, 1, 0),
           costly_punish_b = ifelse(behavior_punish == 1 & local_rate_coop_lag < 0.4, 1, 0),
           costly_punish_c = ifelse(behavior_punish == 1 & local_rate_coop_lag < 0.35, 1, 0),
           costly_punish_d = ifelse(behavior_punish == 1 & local_rate_coop_lag < 0.3, 1, 0),
           costly_punish_e = ifelse(behavior_punish == 1 & local_rate_coop_lag < 0.25, 1, 0)) 

```

## Experiment 1 - Peace Analysis

We build the dataset for the peace analysis by referencing the list of connected players.

```{r, message = F, warning = F}
# PART 1
# Regenerate the individual peace status
data1 = data1 %>%
  mutate(peace_individual = ifelse(local_rate_punish_lag == 0 & 
                                     behavior_punish_lag == 0, 1, 0))

# Create the list of alters by superid
ndata_alters_list = ndata1 %>% 
  select(round, game, starts_with("id")) %>%
  filter(round != 0) %>%
  mutate(across(starts_with("id"), ~100*game+parse_number(.))) %>%
  rename(superid = id)

names(ndata_alters_list)[4:20] = c("alter1", "alter2", "alter3", "alter4", 
                                   "alter5", "alter6", "alter7", "alter8",
                                   "alter9", "alter10", "alter11", "alter12",
                                   "alter13", "alter14", "alter15", "alter16",
                                   "alter17")

ndata_alters_lag = ndata_alters_list
names(ndata_alters_lag)[4:20] = paste0("lag_",names(ndata_alters_lag)[4:20])
ndata_alters_lag$round = ndata_alters_lag$round+1

ndata_alters = merge(ndata_alters_list, ndata_alters_lag, 
                     by = c("superid", "round", "game")) %>%
  arrange(superid, round)

behaviors = data1 %>% 
  filter(round != 0) %>%
  select(superid, game, round, behavior, local_rate_punish, behavior_coop_lag, 
         behavior_punish_lag, behavior_defect_lag)

ndata_long_alters = ndata_alters %>%
  select(superid, round, game, starts_with("lag")) %>%
  pivot_longer(cols = starts_with("lag"), values_to = "alter_id") %>%
  filter(is.na(alter_id) == F)

pi_status = data1 %>% 
  select(superid, game, round, behavior, local_rate_punish, peace_individual, behavior_punish_lag)

punish_lag_status = data1 %>%
  select(superid, game, round, behavior_punish)

tdata_merged = ndata_long_alters %>%
  left_join(pi_status, by = c("superid", "round", "game")) %>%
  mutate(prev_round = round - 1) %>%
  left_join(punish_lag_status, 
            by = c("alter_id" = "superid", "game", "prev_round" = "round")) %>%
  rename(alter_punish_lag = behavior_punish)

tdata1 = tdata_merged %>%
  group_by(superid, round, game) %>%
  summarize(alter_punish_count = sum(alter_punish_lag)) %>%
  mutate(alter_punish_flag = ifelse(alter_punish_count == 0, 0, 1)) %>%
  left_join(pi_status, by = c("superid", "game", "round")) %>%
  mutate(harm = ifelse(behavior == "P", 1, 0))
```

```{r}
# given no punishing alters, 280/6655 decisions = 4.21% of followup decisions are made out of peace
# additionally, given presence of punishing alters, 104/1845 = 5.64% of followup decisions are made in peace
xtabs(~peace_individual + behavior_punish + alter_punish_flag, tdata1)
xtabs(~peace_individual + alter_punish_flag, tdata1)

xtabs(~peace_individual + behavior_punish, tdata1)

tdata1 =
  tdata1 %>%
  mutate(behavior_punish = ifelse(behavior == "P", 1, 0))

prop.test(280, 6655)
prop.test(104, 1845)
# no punishers in previous round are in peace
xtabs(~behavior_punish_lag + peace_individual, data1)
sum(xtabs(~behavior_punish_lag + peace_individual, data1))

xtabs(~behavior_punish_lag + alter_punish_flag + harm, tdata1)

tdata2 = tdata1 %>%
  filter(behavior_punish_lag == 0, alter_punish_flag == 0)

xtabs(~harm + alter_punish_flag, tdata2)
# individual peace proportion
prop.test(6518, 10727)
```

```{r}
# Part 2 of peace analysis
# First, break down into 4 categories: harm + harmers, harm + noharmers, no harm
# + harmers, no harm + no harmers (all in round t-1)

# Get count
xtabs(~behavior_punish + peace_individual, tdata1)
xtabs(~peace_individual + current_social_env, tdata2)
# Create as variable type
tdata2 = tdata1 %>% 
  mutate(last_round_type = case_when(behavior_punish_lag == 0 & alter_punish_flag == 0 ~ "NN",
                                     behavior_punish_lag == 0 & alter_punish_flag == 1 ~ "NH",
                                     behavior_punish_lag == 1 & alter_punish_flag == 0 ~ "HN",
                                     behavior_punish_lag == 1 & alter_punish_flag == 1 ~ "HH"),
         current_social_env = ifelse(local_rate_punish == 0, "Peace", "Nonpeace"),
         current_round_type = case_when(behavior != "P" & current_social_env == "Peace" ~ "NN",
                                        behavior != "P" & current_social_env == "Nonpeace" ~ "NH",
                                        behavior == "P" & current_social_env == "Peace" ~ "HN",
                                        behavior == "P" & current_social_env == "Nonpeace" ~ "HH"))
tdata2 %>% 
  filter(last_round_type == "NN") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  na.omit() %>%
  mutate(perc = n/sum(n))

tdata2 %>% 
  filter(last_round_type == "NH") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  na.omit() %>%
  mutate(perc = n/sum(n)) 

tdata2 %>% 
  filter(last_round_type == "HN") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  na.omit() %>%
  mutate(perc = n/sum(n))
        
tdata2 %>% 
  filter(last_round_type == "HH") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  na.omit() %>%
  mutate(perc = n/sum(n)) 
```

## Experiment 2 - Descriptive Statistics

```{r}
exp2data %>%
  group_by(game) %>%
  select(superid) %>%
  unique() %>%
  summarize(n = n()) %>%
  summarize(mean_players = mean(n),
            min_players = min(n),
            max_players = max(n))
```

```{r}
# Count - by arm
# Exclude round 0 data
tpdata_pc = tpdata_pc %>% filter(round > 0) 

# Build the 3 (-) categories
tpdata_pc = tpdata_pc %>%
  mutate(inequality_averse_neg = ifelse(behavior == "P" & wealth_inequal == 0, 1, 0),
         retaliation_neg = ifelse(behavior == "P" & retaliation_harm == 0, 1, 0),
         costly_pun_neg = ifelse(behavior == "P" & costly_punish == 0, 1, 0))
```

```{r}
# Counts/proportions - all behaviors
exp2data %>%
  filter(round > 0) %>%
  group_by(behavior) %>%
  count() %>%
  filter(behavior %in% c("C", "D", "P")) %>%
  ungroup() %>%
  mutate(prop = n/sum(n))

exp2data %>%
  filter(round > 0, time_pressure == "Minus") %>%
  group_by(behavior) %>%
  count() %>%
  filter(behavior %in% c("C", "D", "P")) %>%
  ungroup() %>%
  mutate(prop = n/sum(n))

exp2data %>%
  filter(round > 0, time_pressure == "Plus") %>%
  group_by(behavior) %>%
  count() %>%
  filter(behavior %in% c("C", "D", "P")) %>%
  ungroup() %>%
  mutate(prop = n/sum(n))
```

```{r}
#Exp2 times
exp2data %>%
  filter(round >0) %>%
  group_by(behavior, time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime/1000))
```

```{r}
# Retaliation
tpdata_pc %>%
  filter(retaliation_harm == 1) %>%
  group_by(time_pressure) %>%
  summarize(n = n())
```

```{r}
tpdata_pc %>%
  filter(retaliation_neg == 1) %>%
  group_by(time_pressure) %>%
  count()
```

```{r}
times_re_plus = tpdata_pc %>%
  filter(retaliation_harm == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type = "RE+") %>%
  select(harm_type, time_pressure, mean_dt, se_mean_dt)
```

```{r}
times_re_minus = tpdata_pc %>%
  filter(retaliation_neg == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type = "RE-") %>%
  select(harm_type, time_pressure, mean_dt, se_mean_dt)
```

```{R}
# Cooperation-enhancing
tpdata_pc %>%
  filter(costly_punish == 1) %>%
  group_by(time_pressure) %>%
  count()
```

```{r}
tpdata_pc %>%
  filter(costly_pun_neg == 1) %>%
  group_by(time_pressure) %>%
  count()
```

```{r}
times_ce_plus =  tpdata_pc %>%
  filter(costly_punish == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type = "CE+") %>%
  select(harm_type, time_pressure, mean_dt, se_mean_dt)
```

```{r}
times_ce_minus = tpdata_pc %>%
  filter(costly_pun_neg == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type = "CE-") %>%
  select(harm_type, time_pressure, mean_dt, se_mean_dt)
```

```{r}
# Inequality-averse
tpdata_pc %>%
  filter(wealth_inequal == 1, behavior == "P") %>%
  group_by(time_pressure) %>%
  summarize(n = n())
```

```{r}
# Inequality-averse negative
tpdata_pc %>%
  filter(inequality_averse_neg == 1) %>%
  group_by(time_pressure) %>%
  count()
```

```{r}
times_ia_plus = tpdata_pc %>%
  filter(wealth_inequal == 1, behavior_punish == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type = "IA+") %>%
  select(harm_type, time_pressure, mean_dt, se_mean_dt)
```

```{r}
times_ia_minus =  tpdata_pc %>%
  filter(inequality_averse_neg == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type = "IA-") %>%
  select(harm_type, time_pressure, mean_dt, se_mean_dt)
```

```{r}
fig2R_times = bind_rows(times_re_plus, times_re_minus, times_ce_plus, times_ce_minus, times_ia_plus, times_ia_minus)
```

```{r}
#Unexplained
tpdata_pc %>%
  filter(unexplained_p == 1) %>%
  group_by(time_pressure) %>%
  summarize(n = n())
```

```{r}
# for all p
prop.test(373, 1633) #TP-
prop.test(239, 1643) #TP+

# for RE
prop.test(179, 1633)
prop.test(94, 1643)

# for CE
prop.test(136, 1633)
prop.test(133, 1643)

# for IN
prop.test(171, 1633)
prop.test(141, 1643)
```

```{r}
#Fig 2, left panels
fig2data_1 = tibble(
  behavior = c("C", "C", "D", "D", "P", "P"),
  time_pressure = c("Minus", "Plus", "Minus", "Plus", "Minus", "Plus"),
  count = c(837, 706, 370, 684, 373, 239),
  total = c(1633, 1643, 1633, 1643, 1633, 1643)
)

fig2B_times_data1 = tpdata_pc %>%
  group_by(time_pressure, behavior) %>%
  summarize(mean_dt = mean1(behaviorTime/1000), 
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  filter(behavior %in% c("C", "D", "P"))

fig2data_1 = fig2data_1 %>%
  mutate(prop = count/total,
         se_count = sqrt(prop*(1-prop)/total)) %>%
  left_join(fig2B_times_data1, by = c("time_pressure", "behavior"))

write_csv(fig2data_1, file = "~/Documents/Projects/harming_esn/data/for_visuals/fig2data_1.csv")
```

```{r}
# Fig2, Right panels
fig2data_2 = tibble(
  harm_type = rep(c("RE+", "RE-", "CE+", "CE-", "IA+", "IA-"), 2),
  time_pressure = c(rep("Minus", 6), rep("Plus", 6)),
  count = c(179, 165, 136, 205, 171, 194, 94, 128, 133, 85, 141, 96),
  total = c(rep(1633, 6), rep(1643, 6))
)

fig2data_2 = fig2data_2 %>% 
  mutate(prop = count/total,
         se_count = sqrt(prop*(1-prop)/total)) %>%
  left_join(fig2R_times, by = c("harm_type", "time_pressure"))
write_csv(fig2data_2, file = "~/Documents/Projects/harming_esn/data/for_visuals/fig2data_2.csv")
```

## Experiment 2 - Peace Analysis

```{r}
load("~/Documents/Projects/harming_esn/code/exp2/tpdata_pc.Rdata")
load("~/Documents/Projects/harming_esn/code/exp2/ndata1_tp.Rdata")

tpdata_pc %>%
  group_by(time_pressure, game) %>%
  count()

tp_minus_ids = tpdata_tpoff$gameID %>% unique() %>%
  str_remove_all("\\D+") %>%
  as.numeric()

tp_plus_ids = tpdata_tpon$gameID %>% unique() %>%
  str_remove_all("\\D+") %>%
  as.numeric()

tpdata_pc = tpdata_pc %>% 
  mutate(time_pressure = factor(ifelse(time_pressure == 0, "Minus", "Plus")),
         peace_individual = ifelse(local_rate_punish_lag == 0 &
                                   behavior_punish_lag == 0, 1, 0)) %>%
  as_tibble()

# Create the list of alters by superid
ndata_alters_list = ndata_tp %>% 
  select(round, game, starts_with("id")) %>%
  filter(round != 0) %>%
  mutate(across(starts_with("id"), ~100*game+parse_number(.))) %>%
  rename(superid = id)

names(ndata_alters_list)[4:17] = c("alter1", "alter2", "alter3", "alter4", 
                                   "alter5", "alter6", "alter7", "alter8",
                                   "alter9", "alter10", "alter11", "alter12",
                                   "alter13", "alter14")

ndata_alters_lag = ndata_alters_list
names(ndata_alters_lag)[4:17] = paste0("lag_",names(ndata_alters_lag)[4:17])
ndata_alters_lag$round = ndata_alters_lag$round+1

ndata_alters = merge(ndata_alters_list, ndata_alters_lag, 
                     by = c("superid", "round", "game")) %>%
  arrange(superid, round)

ndata_alters %>%
  as_tibble()

behaviors = tpdata_pc %>% 
  filter(round != 0) %>%
  select(superid, game, round, 
         time_pressure, behavior_punish, 
         local_rate_punish, behavior_coop_lag, 
         behavior_punish_lag, behavior_defect_lag)

ndata_long_alters = ndata_alters %>%
  select(superid, round, game, starts_with("lag")) %>%
  pivot_longer(cols = starts_with("lag"), values_to = "alter_id") %>%
  filter(is.na(alter_id) == F)

pi_status = tpdata_pc %>% 
  as_tibble() %>%
  select(superid, game, round, time_pressure, behavior_punish, local_rate_punish, peace_individual, behavior_punish_lag) %>%
  rename(e_behavior_punish = behavior_punish, 
         e_behavior_punish_lag = behavior_punish_lag)

punish_lag_status = tpdata_pc %>%
  select(superid, game, round, e_behavior_punish)

tdata_merged_tp = ndata_long_alters %>%
  left_join(pi_status, by = c("superid", "round", "game")) %>%
  mutate(prev_round = round-1) %>%
  rename(behavior_punish = e_behavior_punish,
         behavior_punish_lag = e_behavior_punish_lag) %>%
  left_join(punish_lag_status, by = c("alter_id" = "superid", "game", "prev_round" = "round")) %>%
  rename(alter_punish_lag = e_behavior_punish) %>%
  select(superid, time_pressure, game, round, prev_round, name, alter_id, behavior_punish, local_rate_punish, behavior_punish_lag, alter_punish_lag, peace_individual)

tdata_merged_tp %>%
  group_by(superid, round, game) %>%
  summarize(local_count_punish_lag = sum(alter_punish_lag)) %>%
  mutate(prev_social_env = ifelse(local_count_punish_lag == 0, "Not harming", "Harming")) %>%
  left_join(pi_status, by = c("superid", "game", "round"))

tpdata_pc_modified = tdata_merged_tp %>%
  group_by(superid, round, game) %>%
  summarize(local_count_punish_lag = sum(alter_punish_lag)) %>%
  mutate(social_env_lag = ifelse(local_count_punish_lag == 0, "Not harming", "Harming")) %>%
  left_join(pi_status, by = c("superid", "game", "round")) %>%
  rename(behavior_punish = e_behavior_punish,
         behavior_punish_lag = e_behavior_punish_lag)

load(file = "~/Documents/Projects/harming_esn/code/exp2/tpdata_peace_analysis.Rdata")

tpdata_pc_modified = tpdata_pc_modified %>%
  mutate(last_round_type = case_when(behavior_punish_lag == 0 & social_env_lag == "Not harming" ~ "NN",
                                     behavior_punish_lag == 0 & social_env_lag == "Harming" ~ "NH",
                                     behavior_punish_lag == 1 & social_env_lag == "Not harming" ~ "HN",
                                     behavior_punish_lag == 1 & social_env_lag == "Harming" ~ "HH"),
         social_env = ifelse(local_rate_punish == 0, "Not harming", "Harming"),
         current_round_type = case_when(behavior_punish == 0 & social_env == "Not harming" ~ "NN",
                                        behavior_punish == 0 & social_env == "Harming" ~ "NH",
                                        behavior_punish == 1 & social_env == "Not harming" ~ "HN",
                                        behavior_punish == 1 & social_env == "Harming" ~ "HH"))
# Check the numbers of harming
tpdata_pc_modified %>%
  group_by(time_pressure) %>%
  filter(behavior_punish == 1) %>%
  count()

# TP+
tpdata_pc_modified %>%
  filter(time_pressure == "Plus") %>%
  group_by(last_round_type) %>%
  count()

tpdata_pc_modified %>% 
  filter(last_round_type == "NN", time_pressure == "Plus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) #harm total = 23 +57 = 80

tpdata_pc_modified %>% 
  filter(last_round_type == "NH", time_pressure == "Plus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) #harm total = 43 +16 = 59

tpdata_pc_modified %>% 
  filter(last_round_type == "HN", time_pressure == "Plus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) #harm total = 18+28 = 46
         
tpdata_pc_modified %>% 
  filter(last_round_type == "HH", time_pressure == "Plus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n))  #harm total = 24+11 = 35

# all harm = 80+59+46+35 = 220
# 2 NAs - no current neighbors

# TP-
tpdata_pc_modified %>%
  filter(time_pressure == "Minus") %>%
  group_by(last_round_type) %>%
  count()

tpdata_pc_modified %>% 
  filter(last_round_type == "NN", time_pressure == "Minus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) #harm total = 29+49 = 78

tpdata_pc_modified %>% 
  filter(last_round_type == "NH", time_pressure == "Minus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) #harm total = 76+27 = 103

tpdata_pc_modified %>% 
  filter(last_round_type == "HN", time_pressure == "Minus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) #harm total = 25+62 = 87

tpdata_pc_modified %>% 
  filter(last_round_type == "HH", time_pressure == "Minus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) #harm total = 51+25 = 76

xtabs(~behavior_punish_lag + social_env_lag + time_pressure, tpdata_pc_modified)

# all harm = 78+103+87+76 = 344
```

## Experiment 3 - Descriptive Statistics

```{r}
exp3data_pc %>%
  group_by(game) %>%
  count() # 20 games
```

```{r}
# Counting stats
exp3data_pc %>%
  group_by(game) %>%
  select(superid) %>%
  unique() %>%
  summarize(n = n()) %>%
  summarize(mean_players = mean(n),
            min_players = min(n),
            max_players = max(n))

exp3data_pc %>%
  group_by(time_pressure) %>%
  count()
```

```{r}
# Proportions
exp3data_pc %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  filter(behavior %in% c("C", "D", "P")) %>%
  mutate(perc = n/sum(n))
# All: C = 0.321, D = 0.577, P = 0.101

# By TP status
exp3data_pc %>%
  filter(time_pressure == "Minus") %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  filter(behavior %in% c("C", "D", "P")) %>%
  mutate(perc = n/sum(n))
# TP-: C = 0.457, D = 0.554, P = 0.098

exp3data_pc %>%
  filter(time_pressure == "Plus") %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  filter(behavior %in% c("C", "D", "P")) %>%
  mutate(perc = n/sum(n))
# TP+: C = 0.297, D = 0.598, P = 0.104
```

```{r}
# Decision times
exp3data_pc %>%
  group_by(behavior) %>%
  summarize(mean_dt = mean1(behaviorTime)/1000)

# By TP status
exp3data_pc %>%
  filter(time_pressure == "Minus") %>%
  group_by(behavior) %>%
  summarize(mean_dt = mean1(behaviorTime)/1000)
# C: 3.535, D: 3.241, H: 3.839

exp3data_pc %>%
  filter(time_pressure == "Plus") %>%
  group_by(behavior) %>%
  summarize(mean_dt = mean1(behaviorTime)/1000)
# C: 3.183, D: 3.097, H: 3.462
```

### Create summary datasets

```{r}
# For C/D/P behaviors
exp3_fig_data1 = tibble(
  behavior = rep(c("C", "D", "P"), 2),
  time_pressure = rep(c("Minus","Plus"),3),
  count = c(707, 1128, 200, 655, 1316, 230),
  total = c(2040, 2040, 2040, 2203, 2203, 2203),
  )

exp3_times_minus = exp3data_pc %>%
  filter(time_pressure == "Minus") %>%
  group_by(behavior) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = se_mean(behaviorTime/1000)) %>%
  filter(is.na(behavior) == F) %>%
  mutate(time_pressure = "Minus")

exp3_times_plus = exp3data_pc %>%
  filter(time_pressure == "Plus") %>%
  group_by(behavior) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = se_mean(behaviorTime/1000)) %>%
  filter(is.na(behavior) == F) %>%
  mutate(time_pressure = "Plus")

exp3_fig_data2 = bind_rows(exp3_times_minus, exp3_times_plus) 

exp3_fig_left_data = merge(exp3_fig_data1, exp3_fig_data2, by = c("behavior", "time_pressure")) %>%
  mutate(behavior = ifelse(behavior == "P", "H", behavior),
         prop = count/total,
         se_prop = sqrt(prop/(1-prop)/total)) 

write_csv(exp3_fig_left_data, file = "~/Documents/Projects/harming_esn/data/for_visuals/fig3data_1.csv")

fig3_data1 = read_csv("~/Documents/Projects/harming_esn/data/for_visuals/fig3data_1.csv", show_col_types = F)
fig3_data2 = read_csv("~/Documents/Projects/harming_esn/data/for_visuals/fig3data_2.csv", show_col_types = F)
```


```{r}
exp3_tp_minus_times = exp3data_pc %>%
  filter(time_pressure == "Minus") %>%
  select(behaviorTime) %>%
  pull() / 1000 

exp3_tp_plus_times = exp3data_pc %>%
  filter(time_pressure == "Plus") %>%
  select(behaviorTime) %>%
  pull() / 1000 

t.test(exp3_tp_minus_times, exp3_tp_plus_times)

exp3_tp_minus_coop_times = exp3data_pc %>%
  filter(time_pressure == "Minus", behavior == "C") %>%
  select(behaviorTime) %>%
  pull() / 1000 

exp3_tp_plus_coop_times = exp3data_pc %>%
  filter(time_pressure == "Plus", behavior == "C") %>%
  select(behaviorTime) %>%
  pull() / 1000 

exp3_tp_minus_def_times = exp3data_pc %>%
  filter(time_pressure == "Minus", behavior == "D") %>%
  select(behaviorTime) %>%
  pull() / 1000 

exp3_tp_plus_def_times = exp3data_pc %>%
  filter(time_pressure == "Plus", behavior == "D") %>%
  select(behaviorTime) %>%
  pull() / 1000 

exp3_tp_minus_harm_times = exp3data_pc %>%
  filter(time_pressure == "Minus", behavior == "P") %>%
  select(behaviorTime) %>%
  pull() / 1000 

exp3_tp_plus_harm_times = exp3data_pc %>%
  filter(time_pressure == "Plus", behavior == "P") %>%
  select(behaviorTime) %>%
  pull() / 1000 

t.test(exp3_tp_minus_coop_times, exp3_tp_plus_coop_times)
t.test(exp3_tp_minus_def_times, exp3_tp_plus_def_times)
t.test(exp3_tp_minus_harm_times, exp3_tp_plus_harm_times)
```
### For punishment subtypes
```{r}
exp3_fig_data3 = tibble(
  harm_type = c(rep("RE+", 2), rep("RE-", 2), rep("CE+", 2), rep("CE-", 2), rep("IA+", 2), rep("IA-",2)),
  time_pressure = rep(c("Plus", "Minus"), 6),
  count = c(95, 81, 119, 105, 161, 135, 53, 49, 164, 152, 66, 47),
  total = c(rep(c(2203, 2040), 6))
)

exp3_fig_data3 = exp3_fig_data3 %>%
  mutate(prop = count/total,
         se_prop = sqrt(prop/(1-prop)/total)) %>%
  left_join(exp3_times, by = c("harm_type", "time_pressure"))

write_csv(exp3_fig_data3, file = "~/Documents/Projects/harming_esn/data/for_visuals/fig3data_2.csv")
```

```{r}
# Count - by arm
# Exclude round 0 data
exp3data_pc = exp3data_pc %>% filter(round > 0) %>% 
  mutate(costly_punish = ifelse(behavior_punish == 1 & local_rate_coop_lag < 0.5, 1, 0),
         unexplained_p = ifelse(behavior_punish == 1 & wealth_inequal == 0 & retaliation_harm == 0 &
                                costly_punish == 0, 1, 0),
         inequality_averse_neg = ifelse(behavior == "P" & wealth_inequal == 0, 1, 0),
         retaliation_neg = ifelse(behavior == "P" & retaliation_harm == 0, 1, 0),
         costly_pun_neg = ifelse(behavior == "P" & costly_punish == 0, 1, 0)) 
```

```{r}
exp3data_pc = exp3data_pc %>%
  rename(time_pressure = time_pressure.x)

# Counts - all harming
exp3data_pc %>%
  filter(behavior == "P") %>%
  group_by(time_pressure) %>%
  count() 
```

```{r}
# Retaliation
exp3data_pc %>%
  filter(retaliation_harm == 1) %>%
  group_by(time_pressure) %>%
  summarize(n = n())
```

```{r}
exp3data_pc %>%
  filter(retaliation_neg == 1) %>%
  group_by(time_pressure) %>%
  count()
```

```{r}
times_re_plus = exp3data_pc %>%
  filter(retaliation_harm == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type = "RE+") %>%
  select(harm_type, time_pressure, mean_dt, se_mean_dt)
```

```{r}
times_re_minus = exp3data_pc %>%
  filter(retaliation_neg == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type = "RE-") %>%
  select(harm_type, time_pressure, mean_dt, se_mean_dt)
```

```{R}
# Cooperation-enhancing
exp3data_pc %>%
  filter(costly_punish == 1) %>%
  group_by(time_pressure) %>%
  count()
```

```{r}
exp3data_pc %>%
  filter(costly_pun_neg == 1) %>%
  group_by(time_pressure) %>%
  count()
```

```{r}
times_ce_plus =  exp3data_pc %>%
  filter(costly_punish == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type = "CE+") %>%
  select(harm_type, time_pressure, mean_dt, se_mean_dt)
```

```{r}
times_ce_minus = exp3data_pc %>%
  filter(costly_pun_neg == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type = "CE-") %>%
  select(harm_type, time_pressure, mean_dt, se_mean_dt)
```

```{r}
# Inequality-averse
exp3data_pc %>%
  filter(wealth_inequal == 1, behavior == "P") %>%
  group_by(time_pressure) %>%
  summarize(n = n())
```

```{r}
# Inequality-averse negative
exp3data_pc %>%
  filter(inequality_averse_neg == 1) %>%
  group_by(time_pressure) %>%
  count()
```

```{r}
times_ia_plus = exp3data_pc %>%
  filter(wealth_inequal == 1, behavior_punish == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type = "IA+") %>%
  select(harm_type, time_pressure, mean_dt, se_mean_dt)
```

```{r}
times_ia_minus =  exp3data_pc %>%
  filter(inequality_averse_neg == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = sd1(behaviorTime/1000)/sqrt(sum(is.na(behaviorTime) == 0))) %>%
  mutate(harm_type = "IA-") %>%
  select(harm_type, time_pressure, mean_dt, se_mean_dt)
```

```{r}
exp3_times = bind_rows(times_re_plus, times_re_minus, times_ce_plus, times_ce_minus, times_ia_plus, times_ia_minus)
```

```{r}
#Unexplained
exp3data_pc %>%
  filter(unexplained_p == 1) %>%
  group_by(time_pressure) %>%
  summarize(n = n())
```

```{r}
# All harming
prop.test(c(200, 230), c(2040, 2203), correct = F) # p = 0.53

# for RE
prop.test(c(81, 95), c(2040, 2203), correct = F) # p = 0.577

# for CE
prop.test(c(135, 161), c(2040, 2203), correct = F) # p = 0.3776

# for IA
prop.test(c(152, 164), c(2040, 2203), correct = F) # p = 0.9935
```

## Experiment 3 - Peace Analysis

```{r}
load("~/Documents/Projects/harming_esn/data/exp3/ndata1_exp3.Rdata")
```

```{r}
# Create the list of alters by superid
ndata_alters_list = ndata1 %>% 
  select(round, game, starts_with("id")) %>%
  filter(round != 0) %>%
  mutate(across(starts_with("id"), ~100*game+parse_number(.))) %>%
  rename(superid = id)

names(ndata_alters_list)[4:19] = c("alter1", "alter2", "alter3", "alter4", 
                                   "alter5", "alter6", "alter7", "alter8",
                                   "alter9", "alter10", "alter11", "alter12",
                                   "alter13", "alter14", "alter15", "alter16")

ndata_alters_lag = ndata_alters_list
names(ndata_alters_lag)[4:19] = paste0("lag_",names(ndata_alters_lag)[4:19])
ndata_alters_lag$round = ndata_alters_lag$round+1

ndata_alters = merge(ndata_alters_list, ndata_alters_lag, 
                     by = c("superid", "round", "game")) %>%
  arrange(superid, round)

ndata_long_alters = ndata_alters %>%
  select(superid, round, game, starts_with("lag")) %>%
  pivot_longer(cols = starts_with("lag"), values_to = "alter_id") %>%
  filter(is.na(alter_id) == F)

pi_status = exp3data_pc %>% 
  as_tibble() %>%
  select(superid, game, round, time_pressure, behavior_punish, local_rate_punish, behavior_punish_lag) %>%
  rename(e_behavior_punish = behavior_punish, 
         e_behavior_punish_lag = behavior_punish_lag)

punish_lag_status = tpdata_pc %>%
  select(superid, game, round, e_behavior_punish)

tdata_merged_tp3 = ndata_long_alters %>%
  left_join(pi_status, by = c("superid", "round", "game")) %>%
  mutate(prev_round = round-1) %>%
  rename(behavior_punish = e_behavior_punish,
         behavior_punish_lag = e_behavior_punish_lag) %>%
  left_join(punish_lag_status, by = c("alter_id" = "superid", "game", "prev_round" = "round")) %>%
  rename(alter_punish_lag = e_behavior_punish) %>%
  select(superid, time_pressure, game, round, prev_round, name, alter_id, behavior_punish, local_rate_punish, behavior_punish_lag, alter_punish_lag)

tpdata_pc_modified = tdata_merged_tp3 %>%
  group_by(superid, round, game) %>%
  summarize(local_count_punish_lag = sum(alter_punish_lag)) %>%
  mutate(social_env_lag = ifelse(local_count_punish_lag == 0, "Not harming", "Harming")) %>%
  left_join(pi_status, by = c("superid", "game", "round")) %>%
  rename(behavior_punish = e_behavior_punish,
         behavior_punish_lag = e_behavior_punish_lag)

exp3data_modified = tpdata_pc_modified %>%
  mutate(last_round_type = case_when(behavior_punish_lag == 0 & social_env_lag == "Not harming" ~ "NN",
                                     behavior_punish_lag == 0 & social_env_lag == "Harming" ~ "NH",
                                     behavior_punish_lag == 1 & social_env_lag == "Not harming" ~ "HN",
                                     behavior_punish_lag == 1 & social_env_lag == "Harming" ~ "HH"),
         social_env = ifelse(local_rate_punish == 0, "Not harming", "Harming"),
         current_round_type = case_when(behavior_punish == 0 & social_env == "Not harming" ~ "NN",
                                        behavior_punish == 0 & social_env == "Harming" ~ "NH",
                                        behavior_punish == 1 & social_env == "Not harming" ~ "HN",
                                        behavior_punish == 1 & social_env == "Harming" ~ "HH"))
```

```{r}
# Check the numbers of harming
exp3data_modified %>%
  group_by(time_pressure) %>%
  filter(behavior_punish == 1) %>%
  count()
# les
```
```{R}
# TP+
exp3data_modified %>%
  filter(time_pressure == "Plus") %>%
  group_by(last_round_type) %>%
  count()
```
```{R}
exp3data_modified %>% 
  filter(last_round_type == "NN", time_pressure == "Plus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) #harm total = 23 +57 = 80
```
```{r}
exp3data_modified %>% 
  filter(last_round_type == "NH", time_pressure == "Plus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) #harm total = 43 +16 = 59
```

```{r}
exp3data_modified %>% 
  filter(last_round_type == "HN", time_pressure == "Plus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) #harm total = 18+28 = 46
```

```{r}
exp3data_modified %>% 
  filter(last_round_type == "HH", time_pressure == "Plus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n))  #harm total = 24+11 = 35


```{R}
# TP-
exp3data_modified %>%
  filter(time_pressure == "Minus") %>%
  group_by(last_round_type) %>%
  count()
```

```{R}
exp3data_modified %>% 
  filter(last_round_type == "NN", time_pressure == "Minus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) #harm total = 29+49 = 78
```

```{r}
exp3data_modified %>% 
  filter(last_round_type == "NH", time_pressure == "Minus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) #harm total = 76+27 = 103
```

```{r}
exp3data_modified %>% 
  filter(last_round_type == "HN", time_pressure == "Minus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) #harm total = 25+62 = 87
```

```{r}
exp3data_modified %>% 
  filter(last_round_type == "HH", time_pressure == "Minus") %>%
  group_by(current_round_type) %>%
  summarize(n = n()) %>%
  mutate(perc = n/sum(n)) #harm total = 51+25 = 76
```
```{R}
xtabs(~behavior_punish_lag + social_env_lag + time_pressure, exp3data_modified)
```

# Figures

## Figure 1

```{r}
# Load figure data
fig1data1 = read_csv("~/Documents/Projects/harming_esn/data/for_visuals/fig1data_1.csv", show_col_types = F)
fig1data2 = read_csv("~/Documents/Projects/harming_esn/data/for_visuals/fig1data_2.csv", show_col_types = F)
```

```{r}
# Fig 1A
fig1A = fig1data1 %>%
  mutate(mean_plus_se = prop + se_count,
         mean_minus_se = prop - se_count) %>%
  ggplot() +
  aes(x = behavior, y = prop, fill = behavior) +
  geom_bar(stat = "identity", width = 0.75, alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_minus_se, ymax = mean_plus_se, color = factor(behavior)), width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 0.6), breaks = seq(0, 0.6, by = 0.2), expand = c(0, 0)) +
  ylab("Proportion")+
  facet_grid(~behavior, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())

fig1A
```

```{r}
# Fig 1B
fig1B = fig1data2 %>%
  mutate(harm_type = paste(harm_type_base, pos_neg, sep = "")) %>%
  ggplot() +
  aes(x = factor(pos_neg, levels = c("+", "-")), y = prop, fill = harm_type) +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.5) +
  geom_errorbar(aes(ymin = prop - se_count, ymax = prop + se_count, color = harm_type), 
                position = position_dodge(0.9), width = 0) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2), expand = c(0, 0)) +
  ylab("Proportion")+
  theme_classic() +
  facet_grid(~ harm_type_base, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_fill_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  scale_color_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        strip.placement = "outside",                      # Place facet labels outside x axis labels.
        strip.background = element_rect(fill = "white"),
        )  # Make facet label background white.
```

```{r}
# Fig 1C
fig1C = fig1data1 %>%
  ggplot() +
  aes(x = behavior, y = mean_dt, fill = behavior) +
  geom_bar(stat = "identity", width = 0.9, alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_dt - se_mean_dt, ymax = mean_dt + se_mean_dt, color = factor(behavior)), width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 11), breaks = seq(0, 11, by = 2), expand = c(0, 0)) +
  ylab("Decision time (seconds)")+
  facet_grid(~behavior, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_x_discrete(breaks = c("C", "D", "H"),
                   labels= c("C", "D", "H")) + 
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_text(size = 7.5),
        axis.ticks.y = element_blank())
```

```{r}
# Fig 1D
fig1D = fig1data2 %>%
  mutate(harm_type = paste(harm_type_base, pos_neg, sep = "")) %>%
  ggplot() +
  aes(x = factor(pos_neg, levels = c("+", "-")), y = mean_dt, fill = harm_type) +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_dt - se_mean_dt, ymax = mean_dt + se_mean_dt, color = harm_type), 
                position = position_dodge(0.9), width = 0) +
  scale_y_continuous(limits = c(0, 12), breaks = seq(0, 12, by = 2), expand = c(0, 0)) +
  ylab("Decision time (seconds)")+
  theme_classic() +
  facet_grid(~ harm_type_base, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_fill_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  scale_color_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.placement = "outside",                      # Place facet labels outside x axis labels.
        strip.background = element_rect(fill = "white"),
        )  # Make facet label background white.
```

### Combined Figure 1

```{r}
(fig1A | fig1B) /
(fig1C | fig1D) +
  plot_layout(nrow = 2)
```

## Figure 2

```{r}
# Load the figure data
fig2data_1 = read_csv("~/Documents/Projects/harming_esn/data/for_visuals/fig2data_1.csv", show_col_types = F)
fig2data_2 = read_csv("~/Documents/Projects/harming_esn/data/for_visuals/fig2data_2.csv", show_col_types = F)
```

```{R}
# Fig 2C
fig2C = fig2data_1 %>%
  filter(time_pressure == "Minus") %>%
  mutate(mean_plus_se = prop + se_count,
         mean_minus_se = prop - se_count) %>%
  ggplot() +
  aes(x = behavior, y = prop, fill = behavior) +
  geom_bar(stat = "identity", width = 0.75, alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_minus_se, ymax = mean_plus_se, color = factor(behavior)), width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 0.6), breaks = seq(0, 0.6, by = 0.2), expand = c(0, 0)) +
  ylab("Proportion")+
  facet_grid(~ behavior, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_x_discrete(breaks = c("C", "D", "H"),
                   labels= c("C", "D", "H")) + 
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())
```

```{r}
#Fig 2D
fig2D = fig2data_2 %>%
  mutate(pos_neg_grouping = factor(rep(c("+", "-"), 6), levels = c("+", "-")),
         harm_type_base = rep(c(rep("RE", 2), rep("CE", 2), rep("IA", 2)), 2)) %>%
  filter(time_pressure == "Minus") %>%
  mutate(mean_plus_se = prop + se_count,
         mean_minus_se = prop - se_count) %>%
  ggplot() +
  aes(x = pos_neg_grouping, y = prop, fill = harm_type) +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.5) +
  geom_errorbar(aes(ymin = prop - se_count, ymax = prop + se_count, color = harm_type), 
                position = position_dodge(0.9), width = 0) +
  scale_y_continuous(limits = c(0, 0.15), breaks = seq(0, 0.15, by = 0.05), expand = c(0, 0)) +
  ylab("Proportion")+
  theme_classic() +
  facet_grid(~ harm_type_base, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_fill_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  scale_color_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        strip.placement = "outside",                      # Place facet labels outside x axis labels.
        strip.background = element_rect(fill = "white"),
        )  # Make facet label background white.
```

```{R}
# Fig 2E
fig2E = fig2data_1 %>%
  filter(time_pressure == "Plus") %>%
  mutate(mean_plus_se = prop + se_count,
         mean_minus_se = prop - se_count) %>%
  ggplot() +
  aes(x = behavior, y = prop, fill = behavior) +
  geom_bar(stat = "identity", width = 0.75, alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_minus_se, ymax = mean_plus_se, color = factor(behavior)), width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 0.6), breaks = seq(0, 0.6, by = 0.2), expand = c(0, 0)) +
  ylab("Proportion")+
  scale_x_discrete(breaks = c("C", "D", "H"),
                   labels= c("C", "D", "H")) + 
  facet_grid(~ behavior, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
)
```

```{r}
#Fig 2F
fig2F = fig2data_2 %>%
  mutate(pos_neg_grouping = factor(rep(c("+", "-"), 6), levels = c("+", "-")),
         harm_type_base = rep(c(rep("RE", 2), rep("CE", 2), rep("IA", 2)), 2)) %>%
  filter(time_pressure == "Plus") %>%
  mutate(mean_plus_se = prop + se_count,
         mean_minus_se = prop - se_count) %>%
  ggplot() +
  aes(x = pos_neg_grouping, y = prop, fill = harm_type) +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.5) +
  geom_errorbar(aes(ymin = prop - se_count, ymax = prop + se_count, color = harm_type), 
                position = position_dodge(0.9), width = 0) +
  scale_y_continuous(limits = c(0, 0.15), breaks = seq(0, 0.15, by = 0.05), expand = c(0, 0)) +
  ylab("Proportion")+
  theme_classic() +
  facet_grid(~ harm_type_base, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_fill_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  scale_color_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        strip.placement = "outside",                      # Place facet labels outside x axis labels.
        strip.background = element_rect(fill = "white"),
        )  # Make facet label background white.
```

```{r}
# Fig 2G
fig2G = fig2data_1 %>%
  filter(time_pressure == "Minus") %>%
  ggplot() +
  aes(x = behavior, y = mean_dt, fill = behavior) +
  geom_bar(stat = "identity", width = 0.9, alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_dt - se_mean_dt, ymax = mean_dt + se_mean_dt, color = factor(behavior)), width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 5), breaks = seq(0, 5, by = 2), expand = c(0, 0)) +
  ylab("Decision time (seconds)")+
  facet_grid(~behavior, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_x_discrete(breaks = c("C", "D", "P"),
                   labels= c("C", "D", "H")) + 
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_text(size = 7.5),
        axis.ticks.y = element_blank())
```

```{r}
# Fig 2H
fig2H = fig2data_2 %>%
  mutate(pos_neg_grouping = factor(rep(c("+", "-"), 6), levels = c("+", "-")),
         harm_type_base = rep(c(rep("RE", 2), rep("CE", 2), rep("IA", 2)), 2)) %>%
  filter(time_pressure == "Minus") %>%
  ggplot() +
  aes(x = pos_neg_grouping, y = mean_dt, fill = harm_type) +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_dt - se_mean_dt, ymax = mean_dt + se_mean_dt, color = harm_type), 
                position = position_dodge(0.9), width = 0) +
  scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, by = 2), expand = c(0, 0)) +
  ylab("Decision time (seconds)")+
  theme_classic() +
  facet_grid(~ harm_type_base, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_fill_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  scale_color_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.placement = "outside",                      # Place facet labels outside x axis labels.
        strip.background = element_rect(fill = "white"),
        )  # Make facet label background white.
```

```{r}
# Fig 2I
fig2I = fig2data_1 %>%
  filter(time_pressure == "Plus") %>%
  ggplot() +
  aes(x = behavior, y = mean_dt, fill = behavior) +
  geom_bar(stat = "identity", width = 0.9, alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_dt - se_mean_dt, ymax = mean_dt + se_mean_dt, color = factor(behavior)), width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 5), breaks = seq(0, 5, by = 2), expand = c(0, 0)) +
  ylab("Decision time (seconds)")+
  facet_grid(~behavior, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_x_discrete(breaks = c("C", "D", "P"),
                   labels= c("C", "D", "H")) + 
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank())
```

```{r}
# Fig 2J
fig2J = fig2data_2 %>%
  mutate(pos_neg_grouping = factor(rep(c("+", "-"), 6), levels = c("+", "-")),
         harm_type_base = rep(c(rep("RE", 2), rep("CE", 2), rep("IA", 2)), 2)) %>%
  filter(time_pressure == "Plus") %>%
  ggplot() +
  aes(x = pos_neg_grouping, y = mean_dt, fill = harm_type) +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_dt - se_mean_dt, ymax = mean_dt + se_mean_dt, color = harm_type), 
                position = position_dodge(0.9), width = 0) +
  scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, by = 2), expand = c(0, 0)) +
  ylab("Decision time (seconds)")+
  theme_classic() +
  facet_grid(~ harm_type_base, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_fill_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  scale_color_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        strip.placement = "outside",                      # Place facet labels outside x axis labels.
        strip.background = element_rect(fill = "white"),
        )  # Make facet label background white.
```

### Table for figure 2

```{r}
tpdata_pc %>%
  filter(time_pressure == "Minus") %>%
  mutate(gini2 = ifelse(local_gini >=1, 1, local_gini)) %>%
  summarize(harm_rate = sum(behavior_punish == 1, na.rm = T)/sum(is.na(superid) == 0),
            coop_rate = sum(behavior_coop == 1, na.rm = T)/sum(is.na(superid) == 0))
tpdata_pc %>%
  filter(time_pressure == "Plus") %>%
  mutate(gini2 = ifelse(local_gini >=1, 1, local_gini)) %>%
  summarize(harm_rate = sum(behavior_punish == 1, na.rm = T)/sum(is.na(superid) == 0),
            coop_rate = sum(behavior_coop == 1, na.rm = T)/sum(is.na(superid) == 0))

fig2table = tibble(
  time_pressure = c("TP-", "TP+"),
  harm_rate = c(22.84, 14.55),
  coop_rate = c(51.26, 42.97),
  p_from_reg = c(0.0077, 0.4368)
)

fig2table_t = tibble(
  "Outcome" = c("Harm rate", "Cooperation rate"),
  "TP- (%)" = c(22.84, 51.26),
  "TP+ (%)" = c(14.55, 42.97),
  "p" = c(0.0077, 0.4368)
)
```

### Combined Figure 2

```{r}
(plot_spacer() + plot_spacer()) /
(fig2C | fig2D | fig2E | fig2F) / 
(fig2G | fig2H | fig2I | fig2J) / 
  gridExtra::tableGrob(fig2table_t, rows = NULL) +
  plot_layout(nrow = 4) 
```

## Figure 3 

```{r}
fig3A = fig3_data1 %>%
  filter(time_pressure == "Minus") %>%
  mutate(mean_plus_se = prop + se_prop,
         mean_minus_se = prop - se_prop) %>%
  ggplot() +
  aes(x = behavior, y = prop, fill = behavior) +
  geom_bar(stat = "identity", width = 0.75, alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_minus_se, ymax = mean_plus_se, color = factor(behavior)), width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 0.6), breaks = seq(0, 0.6, by = 0.2), expand = c(0, 0)) +
  ylab("Proportion")+
  facet_grid(~ behavior, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_x_discrete(breaks = c("C", "D", "H"),
                   labels= c("C", "D", "H")) + 
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())
```

```{r}
fig3B = fig3_data2 %>%
  mutate(pos_neg_grouping = factor(substr(harm_type, 3, 3), levels = c("+", "-")),
         harm_type_base = substr(harm_type, 0, 2)) %>%
  filter(time_pressure == "Minus") %>%
  mutate(mean_plus_se = prop + se_prop,
         mean_minus_se = prop - se_prop) %>%
  ggplot() +
  aes(x = pos_neg_grouping, y = prop, fill = harm_type) +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.5) +
  geom_errorbar(aes(ymin = prop - se_prop, ymax = prop + se_prop, color = harm_type), 
                position = position_dodge(0.9), width = 0) +
  scale_y_continuous(limits = c(0, 0.15), breaks = seq(0, 0.15, by = 0.05), expand = c(0, 0)) +
  ylab("Proportion")+
  theme_classic() +
  facet_grid(~ harm_type_base, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_fill_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  scale_color_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        strip.placement = "outside",                      # Place facet labels outside x axis labels.
        strip.background = element_rect(fill = "white"),
        )  # Make facet label background white.
```

```{R}
# Fig 3C
fig3c = fig3_data1 %>%
  filter(time_pressure == "Plus") %>%
  mutate(mean_plus_se = prop + se_prop,
         mean_minus_se = prop - se_prop) %>%
  ggplot() +
  aes(x = behavior, y = prop, fill = behavior) +
  geom_bar(stat = "identity", width = 0.75, alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_minus_se, ymax = mean_plus_se, color = factor(behavior)), width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 0.6), breaks = seq(0, 0.6, by = 0.2), expand = c(0, 0)) +
  ylab("Proportion")+
  scale_x_discrete(breaks = c("C", "D", "H"),
                   labels= c("C", "D", "H")) + 
  facet_grid(~ behavior, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
)
```

```{r}
#Fig 3d
fig3d = fig3_data2 %>%
  mutate(pos_neg_grouping = factor(substr(harm_type, 3, 3), levels = c("+", "-")),
         harm_type_base = substr(harm_type, 0, 2)) %>%
  filter(time_pressure == "Plus") %>%
  mutate(mean_plus_se = prop + se_prop,
         mean_minus_se = prop - se_prop) %>%
  ggplot() +
  aes(x = pos_neg_grouping, y = prop, fill = harm_type) +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.5) +
  geom_errorbar(aes(ymin = prop - se_prop, ymax = prop + se_prop, color = harm_type), 
                position = position_dodge(0.9), width = 0) +
  scale_y_continuous(limits = c(0, 0.15), breaks = seq(0, 0.15, by = 0.05), expand = c(0, 0)) +
  ylab("Proportion")+
  theme_classic() +
  facet_grid(~ harm_type_base, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_fill_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  scale_color_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        strip.placement = "outside",                      # Place facet labels outside x axis labels.
        strip.background = element_rect(fill = "white"),
        )  # Make facet label background white.
```

```{r}
# Fig 3e
fig3e = fig3_data1 %>%
  filter(time_pressure == "Minus") %>%
  ggplot() +
  aes(x = behavior, y = mean_dt, fill = behavior) +
  geom_bar(stat = "identity", width = 0.9, alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_dt - se_mean_dt, ymax = mean_dt + se_mean_dt, color = factor(behavior)), width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 5), breaks = seq(0, 5, by = 2), expand = c(0, 0)) +
  ylab("Decision time (seconds)")+
  facet_grid(~behavior, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_x_discrete(breaks = c("C", "D", "P"),
                   labels= c("C", "D", "H")) + 
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_text(size = 7.5),
        axis.ticks.y = element_blank())
```

```{r}
# Fig 3f
fig3f = fig3_data2 %>%
  mutate(pos_neg_grouping = factor(substr(harm_type, 3, 3), levels = c("+", "-")),
         harm_type_base = substr(harm_type, 0, 2)) %>%
  filter(time_pressure == "Minus") %>%
  ggplot() +
  aes(x = pos_neg_grouping, y = mean_dt, fill = harm_type) +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_dt - se_mean_dt, ymax = mean_dt + se_mean_dt, color = harm_type), 
                position = position_dodge(0.9), width = 0) +
  scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, by = 2), expand = c(0, 0)) +
  ylab("Decision time (seconds)")+
  theme_classic() +
  facet_grid(~ harm_type_base, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_fill_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  scale_color_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.placement = "outside",                      # Place facet labels outside x axis labels.
        strip.background = element_rect(fill = "white"),
        )  # Make facet label background white.
```

```{r}
# Fig 3g
fig3g = fig3_data1 %>%
  filter(time_pressure == "Plus") %>%
  ggplot() +
  aes(x = behavior, y = mean_dt, fill = behavior) +
  geom_bar(stat = "identity", width = 0.9, alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_dt - se_mean_dt, ymax = mean_dt + se_mean_dt, color = factor(behavior)), width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 5), breaks = seq(0, 5, by = 2), expand = c(0, 0)) +
  ylab("Decision time (seconds)")+
  facet_grid(~behavior, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_x_discrete(breaks = c("C", "D", "P"),
                   labels= c("C", "D", "H")) + 
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank())
```

```{r}
# Fig 3h
fig3h = fig2data_2 %>%
  mutate(pos_neg_grouping = factor(substr(harm_type, 3, 3), levels = c("+", "-")),
         harm_type_base = substr(harm_type, 0, 2)) %>%
  filter(time_pressure == "Plus") %>%
  ggplot() +
  aes(x = pos_neg_grouping, y = mean_dt, fill = harm_type) +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_dt - se_mean_dt, ymax = mean_dt + se_mean_dt, color = harm_type), 
                position = position_dodge(0.9), width = 0) +
  scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, by = 2), expand = c(0, 0)) +
  ylab("Decision time (seconds)")+
  theme_classic() +
  facet_grid(~ harm_type_base, 
             scales = "free_x", # Let the x axis vary across facets.
             space = "free_x",  # Let the width of facets vary and force all bars to have the same width.
             switch = "x") +   # Move the facet labels to the bottom.
  scale_fill_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  scale_color_manual(values = c( "thistle1", "slateblue4", "thistle1", "slateblue2", "thistle1", "orchid4"))+
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        strip.placement = "outside",                      # Place facet labels outside x axis labels.
        strip.background = element_rect(fill = "white"),
        )  # Make facet label background white.
```

### Combined Figure 3

```{r}
(fig3A | fig3B | fig3c | fig3d) / 
(fig3e | fig3f | fig3g | fig3h) +
  plot_layout(nrow = 2) +
  plot_annotation(title = "Experiment 3, TP- (left) vs. TP+ (right)")
```

## Figure 2B (Right)

```{r}
fig2B_R_data = read_csv(file = "/Users/gdewey/Library/CloudStorage/Dropbox/Active-AN22HARM-NatEE/Data/figures/fig2BR.csv")

fig2B_R = fig2B_R_data %>%
  mutate(UL = perc + 1.96*se,
         LL = perc - 1.96*se) %>%
  ggplot(aes(x = factor(pun_type), y = perc)) + 
  geom_pointrange(aes(ymin = LL, ymax = UL, color = factor(time_pressure)), fatten = 4) +
  geom_errorbar(aes(ymin = LL, ymax = UL, color = factor(time_pressure)), width = 0.05) +
  theme_bw() +
  xlab("")+
  ylab("Proportion")+
  scale_y_continuous(limits = c(0, 0.25)) +
  scale_x_discrete(breaks = c(1, 2, 3, 4),
                   labels = c("Inequality \naversion", "Retaliation", "Cooperation \nenforcing",  "Unexplained")) +
  scale_color_manual(name = "Time Pressure", 
                     values = c("#FFBF00", "#00A5CF"),
                     labels = c("Inactive", "Active")) +
  theme(panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        legend.title = element_text())

fig2B_R
```


## Figure 4 

```{r}

```


# Regression Models

## Model Set 1

### Model 1.1: Choosing punishment vs. wealth visibility

```{r}
m1.1 = glmer(behavior_punish ~ showScore + age + gender + behavior_coop_lag + local_rate_coop_lag + behavior_punish_lag + local_rate_punish_lag + cPayoffS_lag + degree_lag + happ_lag+ factor(round) + (1|game) + (1|superid), data = data1_cc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))
se = sqrt(diag(vcov(m1.1)))
# table of estimates with 95% CI
tab_m1.1 = cbind(Est = fixef(m1.1), LL = fixef(m1.1) - 1.96 * se, UL = fixef(m1.1) + 1.96 * se)
round(exp(tab_m1.1), digits = 3)[1:11,]
```

### Model 1.2: Choosing cooperation vs. wealth visibility

```{r}
m1.2 = glmer(behavior_coop ~ showScore + age + gender + behavior_coop_lag + local_rate_coop_lag + behavior_punish_lag + local_rate_punish_lag + cPayoffS_lag + degree_lag + happ_lag+ factor(round) + (1|game) + (1|superid), data = data1_cc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))
se = sqrt(diag(vcov(m1.2)))
# table of estimates with 95% CI
tab_m1.2 = cbind(Est = fixef(m1b), LL = fixef(m1b) - 1.96 * se, UL = fixef(m1b) + 1.96 * se)
round(exp(tab_m1.2), digits = 3)[1:11,]
```

### Model 1.3: Choosing defection vs. wealth visibility

```{r}
m1.3 = glmer(behavior_defect ~ showScore + age + gender + behavior_coop_lag + local_rate_defect_lag + behavior_defect_lag + local_rate_punish_lag + cPayoffS_lag + degree_lag + happ_lag+ factor(round) + (1|game) + (1|superid), data = data1_cc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))
se = sqrt(diag(vcov(m1.3)))
# table of estimates with 95% CI
tab_m1.3 = cbind(Est = fixef(m1.3), LL = fixef(m1.3) - 1.96 * se, UL = fixef(m1.3) + 1.96 * se)
round(exp(tab_m1.3), digits = 3)[1:11,]
```

```{r}
tpdata_pc = tpdata_pc %>%
  mutate(behavior_punish = ifelse(behavior == "P" & is.na(behavior) == 0, 1, 0),
         behavior_coop = ifelse(behavior == "C" & is.na(behavior) == 0, 1, 0),
         behavior_defect = ifelse(behavior == "D" & is.na(behavior) == 0, 1, 0))

data_lag = tpdata_pc %>% select(superid, round, initial_score, payoff, 
                                    cumulativePayoff, cPayoffS, WealthLevel, 
                                    behavior_coop, local_rate_coop, 
                                    behavior_defect, local_rate_defect, 
                                    behavior_punish, local_rate_punish, 
                                  degree, happ, behaviorTime)
names(data_lag)[-c(1,2)] = paste0(names(data_lag)[-c(1,2)],"_lag")
data_lag$round = data_lag$round + 1
tpdata_pc = merge(x=tpdata_pc,y=data_lag,all.x=T,all.y=F,by=c("superid","round"))
```

## Experiment 1 Data - Models 8-11

To show the main effect of the experimental condition (either `showScore` or `time_pressure`), we use a shortened model. We regress using Experiment 1 data for proof of concept.

### Model 8: All punishment in Exp. 1

```{r}
m8 = glmer(behavior_punish ~ showScore + age + gender + factor(round) + (1|game) + (1|superid), data = data1_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m8, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(4) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 9: IA in Exp. 1

```{r}
m9 = glmer(wealth_inequal ~ showScore + age + gender + factor(round) + (1|game) + (1|superid), data = data1_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m9, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(4) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 10: RP in Exp. 1

```{r}
m10 = glmer(reactive_p ~ showScore + age + gender + factor(round) + (1|game) + (1|superid), data = data1_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m10, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(4) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 11: UP in Exp. 1

```{r}
m11 = glmer(unexplained_p ~ showScore + age + gender + factor(round) + (1|game) + (1|superid), data = data1_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m11, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(4) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## Experiment 2 Data - Models 12-15

```{r}
dim(tpdata_pc)
```

```{r, message = F, warning = F}
tpdata_pc %>% 
  group_by(superid) %>%
  summarize(n = n())

tpdata_pc %>% 
  group_by(time_pressure, behavior) %>%
  filter(behavior %in% c("C", "D", "P")) %>%
  summarize(n = n())
```

```{r}
# frequencies
# all p
tpdata_pc %>%
  filter(behavior == "P") %>%
  group_by(time_pressure) %>%
  summarize(n = n())

# IA
tpdata_pc %>%
  filter(wealth_inequal == 1, behavior == "P") %>%
  group_by(time_pressure) %>%
  summarize(n = n())

# RP
tpdata_pc %>%
  filter(reactive_p == 1) %>%
  group_by(time_pressure) %>%
  summarize(n = n())

# CP
tpdata_pc %>%
  mutate(costly_punish = ifelse(behavior_punish == 1 & local_rate_coop_lag < 0.5, 1, 0)) %>%
  filter(costly_punish == 1) %>%
  group_by(time_pressure) %>%
  summarize(n = n())

# for all p
binom.confint(373, 1580) #TP-
binom.confint(239, 1629) #TP+

# for RP
binom.confint(200, 1580)
binom.confint(102, 1629)
```

```{r}
# times
tpdata_pc %>%
  filter(behavior == "P") %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime))

tpdata_pc %>%
  filter(wealth_inequal == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime))

tpdata_pc %>%
  filter(reactive_p == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime))

tpdata_pc %>%
  filter(unexplained_p == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime))

tpdata_pc %>%
  filter(reactive_p_neg == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime))

tpdata_pc %>%
  filter(costly_punish == 1) %>%
  group_by(time_pressure) %>%
  summarize(mean_dt = mean1(behaviorTime))


```

### Model 12: All punishment in Exp. 2

```{r}
library(lme4)
m12 = glmer(behavior_punish ~ time_pressure + factor(round) + (1|game) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

tidy(m12, conf.int=TRUE, exponentiate=T) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) 
```

#### Model 12 (linear)

```{r}
m12_lin = lmer(behavior_punish ~ time_pressure + factor(round) + (1|game) + (1|superid), data = tpdata_pc)
tidy(m12_lin, conf.int = TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 13: IA (+) in Exp. 2

```{r}
m13 = glmer(wealth_inequal ~ time_pressure + factor(round) + (1|game) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m13, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

#### Model 13 (linear)

```{r}
m13_lin = lmer(wealth_inequal ~ time_pressure + factor(round) + (1|game) + (1|superid), data = tpdata_pc)

# output with p-values
tidy(m13_lin, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 13b: IA(-) in Exp. 2

```{r}
tpdata_pc = tpdata_pc %>%
  mutate(wealth_inequal_neg = ifelse(wealth_inequal == 0 & behavior_punish == 1, 1, 0))

tpdata_pc %>%
  filter(wealth_inequal == 1, behavior_punish == 1) %>%
  group_by(time_pressure) %>%
  summarize(n = n())

tpdata_pc %>%
  group_by(time_pressure, wealth_inequal_neg) %>%
  filter(wealth_inequal_neg %in% 0:1) %>%
  summarize(n = n())

# 194/1580 0.1228
# 96/1629 0.0628
```

```{r}
m13b= glmer(wealth_inequal_neg ~ time_pressure + factor(round) + (1|game) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m13b, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

#### Model 13b (linear)

```{r}
m13b_lin = lmer(wealth_inequal_neg ~ time_pressure + factor(round) + (1|game) + (1|superid), data = tpdata_pc)

# output with p-values
tidy(m13b_lin, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 14: RP (+) in Exp. 2

```{r}
m14 = glmer(reactive_p ~ time_pressure + factor(round) + (1|game) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m14, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

#### Model 14 (linear)

```{r}
m14_lin = lmer(reactive_p ~ time_pressure + factor(round) + (1|game) + (1|superid), data = tpdata_pc)

# output with p-values
tidy(m14_lin, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 14b: RP (-) in Exp. 2

```{r}
m14b = glmer(reactive_p_neg ~ time_pressure + factor(round) + (1|game) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m14b, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

#### Model 14b (linear)

```{r}
m14b_lin = lmer(reactive_p_neg ~ time_pressure + factor(round) + (1|game) + (1|superid), data = tpdata_pc)

# output with p-values
tidy(m14b_lin, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r}
prop.test(c(370, 280), c(1629, 1580))
```

### Model 15: UP in Exp. 2

```{r}
m15 = glmer(unexplained_p ~ time_pressure + factor(round) + (1|game) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m15, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

#### Model 15 (linear)

```{r}
m15_lin = lmer(unexplained_p ~ time_pressure + factor(round) + (1|game) + (1|superid), data = tpdata_pc)

# output with p-values
tidy(m15_lin, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) %>%
  kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Model 16: Cooperation in Exp. 2

```{r}
m16 = glmer(behavior_coop ~ time_pressure + factor(round) + (1|game) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m16, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2)
```

```{r}
m17 = glmer(behavior_defect ~ time_pressure + factor(round) + (1|game) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m17, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2)
```

### Model 18: Behavioral model for cooperation

```{r}
m18 = glmer(behavior_coop ~ time_pressure + age + gender + behavior_coop_lag + local_rate_coop_lag + behavior_punish_lag + local_rate_punish_lag + cPayoffS_lag + degree_lag + happ_lag + factor(round) + (1|game) + (1|superid), data = tpdata_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

tidy(m18, conf.int = TRUE, exponentiate = TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(11) 
```

## Experiment 3 Data 

```{r}
exp3data_pc
```

### Model 19: All punishment (Exp. 3)

```{r}
m19 = glmer(behavior_punish ~ time_pressure + factor(round) + (1|game) + (1|superid), data = exp3data_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m19, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) 
```

### Model 20: IA+ in Exp 3

```{r}
m20 = glmer(wealth_inequal ~ time_pressure + factor(round) + (1|game) + (1|superid), data = exp3data_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m20, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) 
```

### Model 21: RE+ in Exp. 3

```{r}
m21 = glmer(retaliation_harm ~ time_pressure + factor(round) + (1|game) + (1|superid), data = exp3data_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m21, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2)
```

### Model 22: CP+ in Exp. 3

```{r}
m22 = glmer(costly_punish ~ time_pressure + factor(round) + (1|game) + (1|superid), data = exp3data_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m22, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2)
```

### Model 23: Cooperation in Exp. 3

```{r}
m23 = glmer(behavior_coop ~ time_pressure + factor(round) + (1|game) + (1|superid), data = exp3data_pc, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

# output with p-values
tidy(m23, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2)
```