---
title: "Data Analysis for Harming and Time Pressure"
author: "George Dewey, Hiroyasu Ando, Ryo Ikesu, Akihiro Nishi, TBD"
format: 
  pdf:
    toc: true
editor: visual
---

# Introduction

## Load required packages

```{r, message = F, warning = F}
library(tidyverse)
library(igraph)
library(lme4)
library(lmerTest)
library(DescTools)
library(data.table)
library(broom.mixed)
library(patchwork)
library(stringr)
```

## Load required data

```{r}
## Original harming experiment - Experiment A
load("~/Documents/Projects/harming_esn/data/exp1/exp1data.Rdata")

## TP harming experiment - Experiment B
load("~/Documents/Projects/harming_esn/data/exp4/exp4data.Rdata")
```

## Create grouping variables

```{r}
# define social environment variable from the previous round
# since the rate of punishment, call it coop vs. non-cooperative (i.e. either 
# punish or defecting)
exp1data = exp1data %>%
  mutate(social_env_lag = 
           case_when(local_rate_punish_lag > 0.5 | 
                       local_rate_defect_lag > 0.5 ~ "NC",
                     local_rate_coop_lag > 0.5 ~ "C",
                     TRUE ~ "U"),
         social_env_lag0.4 = 
           case_when(local_rate_punish_lag > 0.4 | 
                       local_rate_defect_lag > 0.4 ~ "NC",
                     local_rate_coop_lag > 0.4 ~ "C",
                     TRUE ~ "U"),
         social_env_lag0.6 = 
                     case_when(local_rate_punish_lag > 0.6 | 
                       local_rate_defect_lag > 0.6 ~ "NC",
                     local_rate_coop_lag > 0.6 ~ "C",
                     TRUE ~ "U"),
         social_env_lag0.7 = 
                     case_when(local_rate_punish_lag > 0.7 | 
                       local_rate_defect_lag > 0.7 ~ "NC",
                     local_rate_coop_lag > 0.7 ~ "C",
                     TRUE ~ "U"),
         social_env_lag0.8 = 
                     case_when(local_rate_punish_lag > 0.8 | 
                       local_rate_defect_lag > 0.8 ~ "NC",
                     local_rate_coop_lag > 0.8 ~ "C",
                     TRUE ~ "U"),
          social_env_lag0.9 = 
                     case_when(local_rate_punish_lag > 0.9 | 
                       local_rate_defect_lag > 0.9 ~ "NC",
                     local_rate_coop_lag > 0.9 ~ "C",
                     TRUE ~ "U"),
         behaviorTime_sec_adj = behaviorTime_sec - 4.5,
         logbehaviorTime_sec_adj = log10(behaviorTime_sec_adj))
```

```{r}
# U is unknown environment
exp4data = exp4data %>%
  mutate(social_env_lag = 
           case_when(local_rate_punish_lag > 0.5 | 
                       local_rate_defect_lag > 0.5 ~ "NC",
                     local_rate_coop_lag > 0.5 ~ "C",
                     TRUE ~ "U"),
         social_env_lag0.4 = 
           case_when(local_rate_punish_lag > 0.4 | 
                       local_rate_defect_lag > 0.4 ~ "NC",
                     local_rate_coop_lag > 0.4 ~ "C",
                     TRUE ~ "U"),
         social_env_lag0.6 = 
                     case_when(local_rate_punish_lag > 0.6 | 
                       local_rate_defect_lag > 0.6 ~ "NC",
                     local_rate_coop_lag > 0.6 ~ "C",
                     TRUE ~ "U"),
         social_env_lag0.7 = 
                     case_when(local_rate_punish_lag > 0.7 | 
                       local_rate_defect_lag > 0.7 ~ "NC",
                     local_rate_coop_lag > 0.7 ~ "C",
                     TRUE ~ "U"),
         social_env_lag0.8 = 
                     case_when(local_rate_punish_lag > 0.8 | 
                       local_rate_defect_lag > 0.8 ~ "NC",
                     local_rate_coop_lag > 0.8 ~ "C",
                     TRUE ~ "U"),
          social_env_lag0.9 = 
                     case_when(local_rate_punish_lag > 0.9 | 
                       local_rate_defect_lag > 0.9 ~ "NC",
                     local_rate_coop_lag > 0.9 ~ "C",
                     TRUE ~ "U"),
         logbehaviorTime_sec_ = log10(behaviorTime_sec))
```

## Create helper functions

```{r}
mean1 = function(x) {mean(x,na.rm=TRUE)}
median1 = function(x) {median(x, na.rm = TRUE)}
sd1 = function(x) {sd(x, na.rm = TRUE)}
se_mean = function(x) sd1(x)/sqrt(sum(is.na(x) == 0))
```

# Analysis

## Descriptive Analysis

```{r}
exp1data %>%
  filter(round != 0)

exp1data = exp1data %>%
  mutate(behavior = case_when(behavior_coop == 1 ~ "C",
                              behavior_defect == 1 ~ "D",
                              behavior_punish == 1 ~ "P"),
         behavior_lag = case_when(behavior_coop_lag == 1 ~ "C",
                                  behavior_defect_lag == 1 ~ "D",
                                  behavior_punish_lag == 1 ~ "P")) 
```

### Per-game characteristics

```{r, message = F}
# Players per game, min, max - Experiment A

exp1data %>%
  filter(round >= 1) %>%
  group_by(game) %>%
  select(superid) %>%
  unique()

exp1data %>%
  filter(round >= 1) %>%
  group_by(game) %>%
  select(superid) %>%
  unique() %>%
  summarize(n = n()) %>%
  summarize(`Mean Players` = mean(n),
            `Min Players` = min(n),
            `Max Players` = max(n))

exp1data %>%
  group_by(showScore) %>%
  count()

exp4data %>%
  group_by(showScore) %>%
  count()
```

```{r, message = F}
# Players per game, min, max - Experiment B
exp4data %>%
  filter(time_pressure == "Minus") %>% 
  group_by(game) %>%
  select(superid) %>%
  unique() %>%
  summarize(n = n()) %>%
  summarize(`Mean Players` = mean(n),
            `Min Players` = min(n),
            `Max Players` = max(n))
```

### Rate of timeout in Exp B, TP+

```{r}
exp4data %>%
  filter(time_pressure == "Plus", round > 0) %>%
  select(superid, game, round, behavior, timeout, behaviorTime_sec)

1341/nrow(exp4data %>% filter(round > 0, time_pressure == "Plus"))
```

### Behavior breakdown

```{r}
# Behavior breakdown - Experiment A
data1_behavior_count = exp1data %>%
  filter(round >= 1) %>%
  mutate(behavior = case_when(behavior_coop == 1 ~ "C",
                              behavior_defect == 1 ~ "D",
                              behavior_punish == 1 ~ "P")) %>%
  group_by(behavior) %>%
  filter(behavior %in% c("C", "D", "P"), round > 0) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  mutate(proportion = count/sum(count))

# Confidence Intervals 
data1_behavior_CI = MultinomCI(x = c(4878, 4336, 652), sides = "two.sided") %>%
  as_tibble()
```

```{r}
# Country breakdown - Experiment A
exp1data %>%
  group_by(country_3cat) %>%
  count() %>%
  ungroup() %>%
  mutate(proportion = n/sum(n))
```

```{r}
# Behavior breakdown - Experiment B
exp4data %>%
  group_by(behavior) %>%
  filter(round >0, behavior %in% c("C", "D", "P")) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  mutate(proportion = count/sum(count))

MultinomCI(c(4185, 5790, 679), sides = "two.sided")
```

```{r}
# Behavior breakdown - Experiment B, TP-
exp4data_tp_minus_count = exp4data %>%
  group_by(behavior) %>%
  filter(time_pressure == "Minus", behavior %in% c("C", "D", "P")) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  mutate(proportion = count/sum(count))

exp4data_tp_minus_CI = MultinomCI(c(2013, 2893, 341), sides = "two.sided")

exp4data_tp_minus_count
```

```{r}
# Behavior breakdown - Experiment B, TP+
exp4data_tp_plus_count = exp4data %>%
  group_by(behavior) %>%
  filter(time_pressure == "Plus", behavior %in% c("C", "D", "P")) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  mutate(proportion = count/sum(count))

exp4data_tp_plus_CI = MultinomCI(c(2172, 2897, 338), sides = "two.sided")

exp4data_tp_plus_count
```

### Wealth increase by initial condition

```{r}
exp1data %>%
  mutate(initial_behavior = case_when(initial_coop == 1 ~ "C",
                                      initial_defect == 1 ~ "D",
                                      initial_punish == 1 ~ "P")) %>%
  filter(initial_behavior %in% c("C", "D", "P"))  %>%
  group_by(initial_score, round, initial_behavior) %>%
  summarize(mean_score = mean1(cumulativePayoff)) %>%
  ggplot() +
  geom_line(aes(x = round, y = mean_score, color = as.factor(initial_score), linetype = as.factor(initial_behavior)))
```
```{r}
exp4data %>%
  mutate(initial_behavior = case_when(initial_coop == 1 ~ "C",
                                      initial_defect == 1 ~ "D",
                                      initial_punish == 1 ~ "P")) %>%
  filter(time_pressure == "Plus", initial_behavior %in% c("C", "D", "P"))  %>%
  group_by(initial_score, round, initial_behavior) %>%
  summarize(mean_score = mean1(cumulativePayoff)) %>%
  ggplot() +
  geom_line(aes(x = round, y = mean_score, color = as.factor(initial_score), linetype = as.factor(initial_behavior)))
```

```{r}
exp4data %>%
  filter(time_pressure == "Minus") %>%
  mutate(initial_behavior = case_when(initial_coop == 1 ~ "C",
                                      initial_defect == 1 ~ "D",
                                      initial_punish == 1 ~ "P")) %>%
  group_by(initial_score, round, initial_behavior) %>%
  summarize(mean_score = mean1(cumulativePayoff)) %>%
  ggplot() +
  geom_line(aes(x = round, y = mean_score, color = as.factor(initial_score), linetype = as.factor(initial_behavior)))
```

### Experiment A - Stratify by social environment

#### Behavior proportions based on social environment, stratified by round (1 vs other)

```{r}
## Unknown environment
exp1_unk_env_rd1_behaviors = exp1data %>%
  filter(social_env_lag == "U", round == 1) %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  ungroup() %>% 
  mutate(perc = n/sum(n),
         total = sum(n),
         round = "rd1")

exp1_unk_env_rd2_behaviors = exp1data %>%
  filter(social_env_lag == "U", round > 1) %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  ungroup() %>% 
  mutate(perc = n/sum(n),
         total = sum(n),
         round = "later")

exp1_unk_behaviors = bind_rows(exp1_unk_env_rd1_behaviors, exp1_unk_env_rd2_behaviors)

## Cooperative environment
exp1_coop_behaviors = exp1data %>%
  filter(social_env_lag == "C", round > 1) %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  ungroup() %>% 
  mutate(perc = n/sum(n),
         total = sum(n),
         environment = "Cooperative",
         expt = "A")


## Non-cooperative environment
exp1_noncoop_behaviors = exp1data %>%
  filter(social_env_lag == "NC", round > 1) %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  ungroup() %>% 
  mutate(perc = n/sum(n),
         total = sum(n),
         environment = "Non-cooperative",
         expt = "A")

exp1_behaviors_sum = bind_rows(exp1_coop_behaviors, exp1_noncoop_behaviors)
```

#### Decision times based on social environment, stratified by round (1 vs other)

```{r}
## Unknown environment
exp1_unk_env_rd1_time_vec = exp1data %>%
  filter(social_env_lag == "U", round == 1) %>%
  group_by(behavior) %>%
  select(behaviorTime_sec) %>%
  pull()

exp1_unk_env_rd1_times = exp1data %>%
  filter(social_env_lag == "U", round == 1) %>%
  group_by(behavior) %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            se_mean_dt = se_mean(behaviorTime_sec))

exp1_unk_env_rd2_time_vec = exp1data %>%
  filter(social_env_lag == "U", round > 1) %>%
  group_by(behavior) %>%
  select(behaviorTime_sec) %>%
  pull()

exp1_unk_env_rd2_times = exp1data %>%
  filter(social_env_lag == "U", round > 1) %>%
  group_by(behavior) %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            se_mean_dt = se_mean(behaviorTime_sec))

exp1_unk_times = bind_rows(exp1_unk_env_rd1_times, exp1_unk_env_rd2_times)

## Cooperative environment
exp1_coop_times = exp1data %>%
  filter(social_env_lag == "C", round > 1) %>%
  group_by(behavior) %>%
  select(behaviorTime_sec) %>%
  pull()

exp1_coop_times_sum = exp1data %>%
  filter(social_env_lag == "C", round > 1) %>%
  group_by(behavior) %>%
  summarize(mean_dt = mean1(behaviorTime_sec_adj),
            se_mean_dt = se_mean(behaviorTime_sec_adj)) %>%
  mutate(environment = "Cooperative")

## Non-cooperative environment
exp1_noncoop_times = exp1data %>%
  filter(social_env_lag == "NC", round > 1) %>%
  group_by(behavior) %>%
  select(behaviorTime_sec) %>%
  pull()

exp1_noncoop_times_sum = exp1data %>%
  filter(social_env_lag == "NC", round > 1) %>%
  group_by(behavior) %>%
  summarize(mean_dt = mean1(behaviorTime_sec_adj),
            se_mean_dt = se_mean(behaviorTime_sec_adj)) %>%
  mutate(environment = "Non-cooperative")

exp1_times_sum = bind_rows(exp1_coop_times_sum, exp1_noncoop_times_sum) %>%
  filter(is.na(behavior) == FALSE)
```

#### Proportions and times, stratified by punished or not in round t-1

```{r}
exp1_last_punished = exp1data %>% filter(round > 1, local_rate_punish_lag > 0)
exp1_last_no_punish = exp1data %>% filter(round > 1, local_rate_punish_lag == 0)

# Proportions
exp1_last_punished %>%
  filter(round > 0) %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  ungroup() %>% 
  mutate(perc = n/sum(n),
         total = sum(n))

exp1_last_no_punish %>%
  filter(round > 0) %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  ungroup() %>% 
  mutate(perc = n/sum(n),
         total = sum(n))

# Times
exp1_last_punished_times = exp1_last_punished %>%
  filter(round > 0) %>%
  select(behaviorTime_sec) %>%
  pull()

exp1_last_no_punish_times = exp1_last_no_punish %>%
  filter(round > 0) %>%
  select(behaviorTime_sec) %>%
  pull()
```

#### Hypothesis testing - Proportions

```{r}
# In unknown environment, round 1 vs rounds > 1
prop.test(x = c(49, 94), n = c(719, 1664), correct = F) # p = 0.27

# In rounds > 1
prop.test(x = c(264, 155), n = c(3177, 4422), correct = F) # p < 0.001
# Significant difference in the proportion of punishment based on social 
# environment
```

#### Hypothesis Testing - Times

```{r}
t.test(exp1_unk_env_rd1_time_vec - 4.5, exp1_unk_env_rd2_time_vec - 4.5, var.equal = F)

t.test(exp1_coop_times - 4.5, exp1_noncoop_times - 4.5, var.equal = F)
```

### Experiment B, TP-, Stratified analysis

```{r}
## Unknown environment
exp4_tp_minus_unk_rd1_behaviors = exp4data %>%
  filter(social_env_lag == "U", round == 1, time_pressure == "Minus") %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  ungroup() %>% 
  mutate(perc = n/sum(n),
         total = sum(n),
         round = "rd1")

exp4_tp_minus_unk_rd2_behaviors = exp4data %>%
  filter(social_env_lag == "U", round > 1, time_pressure == "Minus") %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  ungroup() %>% 
  mutate(perc = n/sum(n),
         total = sum(n),
         round = "later")

exp4_tp_minus_unk_behaviors = bind_rows(exp4_tp_minus_unk_rd1_behaviors, exp4_tp_minus_unk_rd2_behaviors)

## Cooperative environment - behaviors
exp4_tp_minus_coop_behaviors = exp4data %>%
  filter(social_env_lag == "C", round > 1, time_pressure == "Minus") %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  ungroup() %>% 
  mutate(perc = n/sum(n),
         total = sum(n),
         environment = "Cooperative",
         expt = "B, TP-")

## Cooperative environment - times
exp4_tp_minus_coop_times = exp4data %>%
  filter(social_env_lag == "C", round > 1, time_pressure == "Minus", 
         is.na(behavior) == F) %>%
  group_by(behavior) %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            se_mean_dt = se_mean(behaviorTime_sec)) %>%
  mutate(environment = "Cooperative")

## Non-cooperative environment
exp4_tp_minus_noncoop_behaviors = exp4data %>%
  filter(social_env_lag == "NC", round > 1, time_pressure == "Minus") %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  ungroup() %>% 
  mutate(perc = n/sum(n),
         total = sum(n),
         environment = "Non-cooperative",
         expt = "B, TP-")

## Non-coopearative environment - times
exp4_tp_minus_noncoop_times = exp4data %>%
  filter(social_env_lag == "NC", round > 1, time_pressure == "Minus", 
         is.na(behavior) == F) %>%
  group_by(behavior) %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            se_mean_dt = se_mean(behaviorTime_sec)) %>%
  mutate(environment = "Non-cooperative")


## Punisher in last round
exp4_tp_minus_last_punished = exp4data %>%
  filter(round > 1, time_pressure == "Minus", local_rate_punish_lag > 0)

exp4_tp_minus_last_nopunish = exp4data %>%
    filter(round > 1, time_pressure == "Minus", local_rate_punish_lag == 0)

exp4_tp_minus_sum = bind_rows(exp4_tp_minus_coop_times, exp4_tp_minus_noncoop_times)
exp4_tp_minus_behaviors_sum = bind_rows(exp4_tp_minus_coop_behaviors, exp4_tp_minus_noncoop_behaviors)

```

#### Hypothesis testing - proportions

```{r}
exp4_tp_minus_unk_behaviors
prop.test(c(27, 69), c(367, 1127)) # p = 0.4745 in unknown

exp4_tp_minus_coop_behaviors #74/1258

exp4_tp_minus_noncoop_behaviors #171/2540

prop.test(c(74, 171), c(1258, 2540)) # p = 0.35 in coop vs noncoop
```

### Experiment B, TP+ - Stratify by social environment

```{r}
## Unknown environment
exp4_unk_env_rd1_behaviors = exp4data %>%
  filter(social_env_lag == "U", round == 1, time_pressure == "Plus") %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  ungroup() %>% 
  mutate(perc = n/sum(n),
         total = sum(n),
         round = "rd1")

exp4_unk_env_rd2_behaviors = exp4data %>%
  filter(social_env_lag == "U", round > 1, time_pressure == "Plus") %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  ungroup() %>% 
  mutate(perc = n/sum(n),
         total = sum(n),
         round = "later")

exp4_unk_behaviors_tp_plus = bind_rows(exp4_unk_env_rd1_behaviors, exp4_unk_env_rd2_behaviors)
exp4_unk_behaviors_tp_plus
```

```{r}
## Cooperative environment - behaviors
exp4_coop_behaviors_tp_plus = exp4data %>%
  filter(social_env_lag == "C", round > 1, time_pressure == "Plus") %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  ungroup() %>% 
  mutate(perc = n/sum(n),
         total = sum(n),
         environment = "Cooperative",
         expt = "B, TP+")

## Cooperative environment - times
exp4_coop_tp_plus_times = exp4data %>%
  filter(social_env_lag == "C", round > 1, time_pressure == "Plus",
         is.na(behavior) == F) %>%
  group_by(behavior) %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            se_mean_dt = se_mean(behaviorTime_sec)) %>%
  mutate(environment = "Cooperative")

## Non-cooperative environment - behaviors
exp4_noncoop_behaviors_tp_plus = exp4data %>%
  filter(social_env_lag == "NC", round > 1, time_pressure == "Plus") %>%
  group_by(behavior) %>%
  summarize(n = n()) %>%
  ungroup() %>% 
  mutate(perc = n/sum(n),
         total = sum(n),
         environment = "Non-cooperative",
         expt = "B, TP+")

## Non-cooperative environmnet - times
exp4_noncoop_tp_plus_times = exp4data %>%
  filter(social_env_lag == "NC", round > 1, time_pressure == "Plus",
         is.na(behavior) == F) %>%
  group_by(behavior) %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            se_mean_dt = se_mean(behaviorTime_sec)) %>%
  mutate(environment = "Non-cooperative")

## Punish in last round
exp4_tp_plus_last_punished = exp4data %>%
  filter(round > 1, time_pressure == "Plus", local_rate_punish_lag > 0)

exp4_tp_plus_last_nopunish = exp4data %>%
    filter(round > 1, time_pressure == "Plus", local_rate_punish_lag == 0)

exp4_tp_plus_sum = bind_rows(exp4_coop_tp_plus_times, exp4_noncoop_tp_plus_times)
exp4_tp_plus_behavior_sum = bind_rows(exp4_coop_behaviors_tp_plus, exp4_noncoop_behaviors_tp_plus)
```

#### Hypothesis testing - proportions

```{r}
prop.test(c(27, 82), c(372, 1118)) # p = 0.999
```

```{r}
prop.test(c(165, 64), c(2627, 1338)) # p = 0.065
```

```{r}
# Create the dataset for fig3


```

### Network characteristics

```{r}
# Network statistics
mean1(exp1data$degree)

mean1(exp4data$degree)
```

### Payoff

```{r}
mean1(exp1data$cumulativePayoff)
mean1(exp4data$cumulativePayoff)

exp4data %>%
  group_by(time_pressure) %>%
  summarize(mean_payoff = mean1(cumulativePayoff),
            se_mean_payoff = se_mean(cumulativePayoff))
```

## Decision time

```{r}
# Times per behavior
data1_times = exp1data %>%
  mutate(behavior = case_when(behavior_coop == 1 ~ "C",
                              behavior_defect == 1 ~ "D",
                              behavior_punish == 1 ~ "P")) %>%
  group_by(behavior) %>%
  filter(behavior %in% c("C", "D", "P")) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            mean_dt_adjusted = mean1((behaviorTime - 4500)/1000),
            se_mean_dt = se_mean(behaviorTime/1000),
            UL_mean = mean_dt_adjusted + 1.96*se_mean_dt,
            LL_mean = mean_dt_adjusted - 1.96*se_mean_dt)
data1_times
```

### Stratify by presence of harmers in last round

```{r}
exp1data = exp1data %>%
  mutate(previously_harmed = ifelse(local_rate_punish_lag == 0, 0, 1),
         behavior = case_when(behavior_coop == 1 ~ "C",
                              behavior_defect == 1 ~ "D",
                              behavior_punish == 1 ~ "P"))
```

```{r}
exp4data = exp4data %>%
  mutate(previously_harmed = ifelse(local_rate_punish_lag == 0, 0, 1),
         behavior = case_when(behavior_coop == 1 ~ "C",
                              behavior_defect == 1 ~ "D",
                              behavior_punish == 1 ~ "P"))
```

```{r}
exp1data %>%
  mutate(previously_harmed = ifelse(local_rate_punish_lag == 0, 0, 1),
         behavior = case_when(behavior_coop == 1 ~ "C",
                              behavior_defect == 1 ~ "D",
                              behavior_punish == 1 ~ "P")) %>%
  group_by(previously_harmed, behavior) %>%
  filter(behavior %in% c("C", "D", "P"), previously_harmed %in% 0:1) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            mean_dt_adjusted = mean1((behaviorTime - 4500)/1000),
            se_mean_dt = se_mean(behaviorTime/1000))
```

```{r}
## Behavior times, TP-
exp4_tp_minus_times = exp4data %>%
  group_by(behavior) %>%
  filter(time_pressure == "Minus", behavior %in% c("C", "D", "P")) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = se_mean(behaviorTime/1000),
            LL_mean = mean_dt - 1.96*se_mean_dt,
            UL_mean = mean_dt + 1.96*se_mean_dt)


exp4_tp_minus_times
```

```{r}
## Behavior times, TP+
exp4data_tp_plus_times = exp4data %>%
  group_by(behavior) %>%
  filter(time_pressure == "Plus", behavior %in% c("C", "D", "P")) %>%
  summarize(mean_dt = mean1(behaviorTime/1000),
            se_mean_dt = se_mean(behaviorTime/1000),
            LL_mean = mean_dt - 1.96*se_mean_dt,
            UL_mean = mean_dt + 1.96*se_mean_dt)
exp4data_tp_plus_times
```

# Figures

## Manuscript Figure 2 - Behavior Distribution and Decision Times, Experiment A

### Behavior Frequencies and Decision Time, Experiment A

```{r}
# Fig 1A
exp1_fig1_data = bind_cols(data1_behavior_count, data1_behavior_CI, data1_times)[-7] 
names(exp1_fig1_data) = c("behavior", "count", "crude_prop", "adjusted_prop", "LL", "UL",
                          "mean_dt", "recentered_mean_dt", "se_mean_dt")
```

```{r}
exp1_fig1_A = exp1_fig1_data %>%
  ggplot() +
  aes(x = behavior, y = adjusted_prop, fill = behavior) +
  geom_bar(stat = "identity", width = 0.75, alpha = 0.5) +
  geom_errorbar(aes(ymin = LL, ymax = UL, color = factor(behavior)), width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 0.6), breaks = seq(0, 0.6, by = 0.2), expand = c(0, 0)) +
  scale_x_discrete(breaks = c("C", "D", "P")) +
  ylab("Proportion") +
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())
exp1_fig1_A
```

```{r}
exp1_fig1_B = exp1_fig1_data %>%
  ggplot() +
  aes(x = behavior, y = recentered_mean_dt, fill = behavior) +
  geom_bar(stat = "identity", width = 0.75, alpha = 0.5) +
  geom_errorbar(aes(ymin = recentered_mean_dt - 1.96*se_mean_dt, 
                    ymax = recentered_mean_dt + 1.96*se_mean_dt, 
                    color = factor(behavior)), width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 8), breaks = seq(0, 8, by = 2), expand = c(0, 0)) +
  scale_x_discrete(breaks = c("C", "D", "P")) +
  ylab("Decision time \n (seconds)")+
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())
exp1_fig1_B
```

```{r}
exp1_fig1_A / exp1_fig1_B +
  plot_annotation(tag_levels = c("A", "B"))

ggsave(filename = "~/Documents/Projects/harming_esn/figures/fig2.png", width = 7, height = 5, units = "in")
```

## Manuscript Figure 3 - Behavior Distribution and Decision Times, Experiment B

### Behavior Frequencies and Decision Time, Experiment B

```{r}
exp4_tp_plus_fig1_data = bind_cols(exp4data_tp_plus_count, exp4data_tp_plus_CI, exp4data_tp_plus_times)[-7]
names(exp4_tp_plus_fig1_data) = c("behavior", "count", "crude_prop", 
                                  "adjusted_prop", "LL", "UL", "mean_dt", 
                                  "se_mean_dt")

exp4_tp_minus_fig1_data = bind_cols(exp4data_tp_minus_count, exp4data_tp_minus_CI, exp4_tp_minus_times)[-7]
names(exp4_tp_minus_fig1_data) = c("behavior", "count", "prop", "adjusted_prop", 
                              "LL", "UL", "mean_dt", "se_mean_dt")
```

```{r}
exp4_fig1_A = exp4_tp_plus_fig1_data %>%
  ggplot() +
  aes(x = behavior, y = adjusted_prop, fill = behavior) +
  geom_bar(stat = "identity", width = 0.75, alpha = 0.5) +
  geom_errorbar(aes(ymin = LL, ymax = UL, color = factor(behavior)), width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 0.6), breaks = seq(0, 0.6, by = 0.2), expand = c(0, 0)) +
  scale_x_discrete(breaks = c("C", "D", "P")) +
  ylab("Proportion")+
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        plot.title = element_text(size = 8),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank()) 
exp4_fig1_A
```

```{r}
exp4_fig1_B = exp4_tp_plus_fig1_data %>%
  ggplot() +
  aes(x = behavior, y = mean_dt, fill = behavior) +
  geom_bar(stat = "identity", width = 0.75, alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_dt - 1.96*se_mean_dt, 
                    ymax = mean_dt + 1.96*se_mean_dt, 
                    color = factor(behavior)), width = 0) +
  geom_hline(yintercept = 3, color = "red2", alpha = 0.3) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 8), breaks = seq(0, 8, by = 2), expand = c(0, 0)) +
  scale_x_discrete(breaks = c("C", "D", "P")) +
  ylab("Decision time \n (seconds)")+
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())
exp4_fig1_B
```

```{r}
exp4_fig1_C = exp4_tp_minus_fig1_data %>%
  ggplot() +
  aes(x = behavior, y = adjusted_prop, fill = behavior) +
  geom_bar(stat = "identity", width = 0.75, alpha = 0.5) +
  geom_errorbar(aes(ymin = LL, ymax = UL, color = factor(behavior)), width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 0.6), breaks = seq(0, 0.6, by = 0.2), expand = c(0, 0)) +
  scale_x_discrete(breaks = c("C", "D", "P")) +
  ylab("Proportion") +
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",        
        plot.title = element_text(size = 8),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank()) 
exp4_fig1_C
```

```{r}
exp4_fig1_D = exp4_tp_minus_fig1_data %>%
  ggplot() +
  aes(x = behavior, y = mean_dt, fill = behavior) +
  geom_bar(stat = "identity", width = 0.75, alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_dt - se_mean_dt, 
                    ymax = mean_dt + se_mean_dt, 
                    color = factor(behavior)), width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 8), breaks = seq(0, 8, by = 2), expand = c(0, 0)) +
  scale_x_discrete(breaks = c("C", "D", "P")) +
  ylab("Decision time \n (seconds)")+
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())

exp4_fig1_D
```

```{r}
(exp4_fig1_C + exp4_fig1_A) / ( exp4_fig1_D + exp4_fig1_B) +
  plot_annotation(tag_levels = c("A", "C", "B", "D")) &
  theme(plot.tag = element_text(size = 10))
ggsave(filename = "~/Documents/Projects/harming_esn/figures/fig3.png", width = 7, height = 5, units = "in")
```

## Manuscript Figure 4 - Rates of punishment types in Experiment 2

```{r}
# Get the frequencies stratified by TP status and by punishment type
fig4_tp_minus_CR = exp4data %>% 
  filter(time_pressure == "Minus") %>%
  group_by(punish_type_CR) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP-",
         punish_type = "CR",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_CR == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_minus_IA = exp4data %>% 
  filter(time_pressure == "Minus") %>%
  group_by(punish_type_IA) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP-",
         punish_type = "IA",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_IA == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_minus_NR = exp4data %>% 
  filter(time_pressure == "Minus") %>%
  group_by(punish_type_NR) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP-",
         punish_type = "NR",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_NR == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_minus_U = exp4data %>% 
  filter(time_pressure == "Minus") %>%
  group_by(punish_type_U) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP-",
         punish_type = "U",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_U == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_minus_data = bind_rows(fig4_tp_minus_CR, fig4_tp_minus_IA, fig4_tp_minus_NR, fig4_tp_minus_U)
```

```{R}
fig4_tp_Plus_CR = exp4data %>% 
  filter(time_pressure == "Plus") %>%
  group_by(punish_type_CR) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP+",
         punish_type = "CR",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_CR == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_Plus_IA = exp4data %>% 
  filter(time_pressure == "Plus") %>%
  group_by(punish_type_IA) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP+",
         punish_type = "IA",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_IA == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_Plus_NR = exp4data %>% 
  filter(time_pressure == "Plus") %>%
  group_by(punish_type_NR) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP+",
         punish_type = "NR",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_NR == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_Plus_U = exp4data %>% 
  filter(time_pressure == "Plus") %>%
  group_by(punish_type_U) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP+",
         punish_type = "U",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_U == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_Plus_data = bind_rows(fig4_tp_Plus_CR, fig4_tp_Plus_IA, fig4_tp_Plus_NR, fig4_tp_Plus_U)

exp4data_combined = bind_rows(fig4_tp_minus_data, fig4_tp_Plus_data)

exp4data_combined
```

```{r}
# Run the regression models for each condition to test the effect of time pressure to get p-values
fig4_model_NR = glmer(punish_type_NR ~ time_pressure + factor(round) + (1|game) + (1|superid), data = exp4data, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))
tidy(fig4_model_NR, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) # p = 0.6282

fig4_model_CR = glmer(punish_type_CR ~ time_pressure + factor(round) + (1|game) + (1|superid), data = exp4data, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))
tidy(fig4_model_CR, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) # p = 0.888

fig4_model_IA = glmer(punish_type_IA ~ time_pressure + factor(round) + (1|game) + (1|superid), data = exp4data, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))
tidy(fig4_model_IA, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) # p = 0.436

fig4_model_U = glmer(punish_type_U ~ time_pressure + factor(round) + (1|game) + (1|superid), data = exp4data, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))
tidy(fig4_model_U, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) # p = 0.539
```

### Decision times

```{r}
exp4data_plus_NR_times = exp4data %>% 
  filter(punish_type_NR == 1, 
         behavior_punish == 1, 
         time_pressure == "Plus") %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            se_mean_dt = se_mean(behaviorTime_sec)) %>%
  mutate(punish_type = "NR",
         setting = "TP+",
           mean_LL = mean_dt - 1.96*se_mean_dt,
         mean_UL = mean_dt + 1.96*se_mean_dt) 

exp4data_plus_CR_times = exp4data %>% 
  filter(punish_type_CR == 1, 
         behavior_punish == 1, 
         time_pressure == "Plus") %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            se_mean_dt = se_mean(behaviorTime_sec)) %>%
  mutate(punish_type = "CR",
         setting = "TP+",
         mean_LL = mean_dt - 1.96*se_mean_dt,
         mean_UL = mean_dt + 1.96*se_mean_dt) 

exp4data_plus_IA_times = exp4data %>% 
  filter(punish_type_IA == 1, 
         behavior_punish == 1, 
         time_pressure == "Plus") %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            se_mean_dt = se_mean(behaviorTime_sec)) %>%
  mutate(punish_type = "IA",
                  setting = "TP+",
           mean_LL = mean_dt - 1.96*se_mean_dt,
         mean_UL = mean_dt + 1.96*se_mean_dt) 

exp4data_plus_U_times = exp4data %>% 
  filter(punish_type_U == 1, 
         behavior_punish == 1, 
         time_pressure == "Plus") %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            se_mean_dt = se_mean(behaviorTime_sec)) %>%
  mutate(punish_type = "U",
         setting = "TP+",
         mean_LL = mean_dt - 1.96*se_mean_dt,
         mean_UL = mean_dt + 1.96*se_mean_dt) 

exp4data_minus_NR_times = exp4data %>% 
  filter(punish_type_NR == 1, 
         behavior_punish == 1, 
         time_pressure == "Minus") %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            se_mean_dt = se_mean(behaviorTime_sec)) %>%
  mutate(punish_type = "NR",
                  setting = "TP-",
           mean_LL = mean_dt - 1.96*se_mean_dt,
         mean_UL = mean_dt + 1.96*se_mean_dt) 

exp4data_minus_CR_times = exp4data %>% 
  filter(punish_type_CR == 1, 
         behavior_punish == 1, 
         time_pressure == "Minus") %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            se_mean_dt = se_mean(behaviorTime_sec)) %>%
  mutate(punish_type = "CR",
         setting = "TP-",
        mean_LL = mean_dt - 1.96*se_mean_dt,
         mean_UL = mean_dt + 1.96*se_mean_dt) 

exp4data_minus_IA_times = exp4data %>% 
  filter(punish_type_IA == 1, 
         behavior_punish == 1, 
         time_pressure == "Minus") %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            se_mean_dt = se_mean(behaviorTime_sec)) %>%
  mutate(punish_type = "IA",
         setting = "TP-",
         mean_LL = mean_dt - 1.96*se_mean_dt,
         mean_UL = mean_dt + 1.96*se_mean_dt) 

exp4data_minus_U_times = exp4data %>% 
  filter(punish_type_U == 1, 
         behavior_punish == 1, 
         time_pressure == "Minus") %>%
  summarize(mean_dt = mean1(behaviorTime_sec),
            se_mean_dt = se_mean(behaviorTime_sec)) %>%
  mutate(punish_type = "U",
         setting = "TP-",
         mean_LL = mean_dt - 1.96*se_mean_dt,
         mean_UL = mean_dt + 1.96*se_mean_dt) 

exp4data_times = bind_rows(exp4data_minus_CR_times, exp4data_minus_IA_times, exp4data_minus_NR_times, exp4data_minus_U_times, exp4data_plus_CR_times, exp4data_plus_IA_times, exp4data_plus_NR_times, exp4data_plus_U_times)
```

```{r}
exp4data_times %>%
  ggplot(aes(x = punish_type, y = mean_dt, fill = setting)) +
  geom_bar(position = "dodge", stat = "identity", alpha = 0.5, show.legend = T) +
  geom_errorbar(aes(ymin = mean_LL,
                    ymax = mean_UL,
                    color = factor(setting),
                    width = 0),
                position = position_dodge(.9),
                show.legend = F) +
  scale_fill_manual(values = c("slategray2", "goldenrod2"),
                    labels = c("TP-", "TP+"))+
  scale_color_manual(values = c("dodgerblue4", "darkorange3"), guide = "none") +
  scale_y_continuous(limits = c(0, 6), expand = c(0, 0)) +
  ylab("Decision time \n (seconds)") +
  xlab("") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank()) 
```



### Main
```{r}
# Create the combined figure
exp4data_combined %>%
  ggplot(aes(x = punish_type, y = perc, fill = setting)) +
  geom_bar(position = "dodge", stat = "identity", alpha = 0.5, show.legend = T) +
  geom_errorbar(aes(ymin = perc + 1.96*se_perc, 
                    ymax = perc - 1.96*se_perc,
                    color = factor(setting),
                    width = 0),
                position = position_dodge(.9),
                show.legend = F) +
  annotate("text", x = 1:4, 
           y = c(0.025, 0.045, 0.043, 0.02), 
           label = c("italic(p) == 0.888", "italic(p) == 0.436", "italic(p) == 0.628", "italic(p) == 0.545"), 
           parse = T) +
  scale_fill_manual(values = c("slategray2", "goldenrod2"),
                    labels = c("TP-", "TP+"))+
  scale_color_manual(values = c("dodgerblue4", "darkorange3"), guide = "none") +
  scale_y_continuous(limits = c(0, 0.05), expand = c(0, 0)) +
  ylab("Proportion") +
  xlab("") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank()) 

ggsave(filename = "~/Documents/Projects/harming_esn/figures/fig4.png", width = 7, height = 5, units = "in")
```

## Supplementary Figure - Figure S1, punish types in Experiment 1

```{r}
exp1data_NR = exp1data %>% 
  group_by(punish_type_NR) %>%
  count() %>%
  ungroup() %>%
  mutate(punish_type = "NR",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_NR == 1)  %>%
  select(punish_type, n, total, perc, se_perc)

exp1data_IA = exp1data %>% 
  group_by(punish_type_IA) %>%
  count() %>%
  ungroup() %>%
  mutate(punish_type = "IA",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_IA == 1)  %>%
  select(punish_type, n, total, perc, se_perc)

exp1data_CR = exp1data %>% 
  group_by(punish_type_CR) %>%
  count() %>%
  ungroup() %>%
  mutate(punish_type = "CR",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_CR == 1)  %>%
  select(punish_type, n, total, perc, se_perc)

exp1data_U = exp1data %>% 
  group_by(punish_type_U) %>%
  count() %>%
  ungroup() %>%
  mutate(punish_type = "U",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_U == 1)  %>%
  select(punish_type, n, total, perc, se_perc)

figS1data = bind_rows(exp1data_CR, exp1data_IA, exp1data_NR, exp1data_U)

figS1data = figS1data %>%
  mutate(perc_LL = perc - 1.96*se_perc,
         perc_UL = perc + 1.96*se_perc)
figS1data
```

#### Decision times by punish type Exp 1

```{r}
# Decision times by punish type

exp1data_NR_times = exp1data %>% 
  filter(punish_type_NR == 1, behavior_punish == 1) %>%
  summarize(mean_dt = mean1(behaviorTime_sec - 4.5),
            se_mean_dt = se_mean(behaviorTime_sec - 4.5)) %>%
  mutate(punish_type = "NR",
           mean_LL = mean_dt - 1.96*se_mean_dt,
         mean_UL = mean_dt + 1.96*se_mean_dt) 

exp1data_IA_times = exp1data %>% 
  filter(punish_type_IA == 1, behavior_punish == 1) %>%
  summarize(mean_dt = mean1(behaviorTime_sec - 4.5),
            se_mean_dt = se_mean(behaviorTime_sec - 4.5),
) %>%
  mutate(punish_type = "IA",   mean_LL = mean_dt - 1.96*se_mean_dt,
         mean_UL = mean_dt + 1.96*se_mean_dt) 

exp1data_CR_times = exp1data %>% 
  filter(punish_type_CR == 1, behavior_punish == 1) %>%
  summarize(mean_dt = mean1(behaviorTime_sec - 4.5),
            se_mean_dt = se_mean(behaviorTime_sec - 4.5)) %>%
  mutate(punish_type = "CR",
           mean_LL = mean_dt - 1.96*se_mean_dt,
         mean_UL = mean_dt + 1.96*se_mean_dt) 

exp1data_U_times = exp1data %>% 
  filter(punish_type_U == 1, behavior_punish == 1) %>%
  summarize(mean_dt = mean1(behaviorTime_sec - 4.5),
            se_mean_dt = se_mean(behaviorTime_sec - 4.5)) %>%
  mutate(punish_type = "U",
         mean_LL = mean_dt - 1.96*se_mean_dt,
         mean_UL = mean_dt + 1.96*se_mean_dt) 

exp1data_punish_types_times = bind_rows(exp1data_NR_times, 
                                        exp1data_CR_times,
                                        exp1data_IA_times, 
                                        exp1data_U_times) %>% select(punish_type, mean_dt, se_mean_dt, mean_LL, mean_UL)
  
figS1data %>%
  left_join(exp1data_punish_types_times, by = "punish_type")
```

#### Figure
```{r}
fig_S1_A = figS1data %>%
  ggplot(aes(x = punish_type, y = perc)) +
  geom_bar(position = "dodge", stat = "identity", fill = "slategray2", alpha = 0.5, show.legend = T) +
  geom_errorbar(aes(ymin = perc + 1.96*se_perc, 
                    ymax = perc - 1.96*se_perc,
                    width = 0),
                color = "dodgerblue4",
                position = position_dodge(.9),
                show.legend = F) +
  scale_color_manual(values = c("dodgerblue4"), guide = "none") +
  scale_y_continuous(limits = c(0, 0.05), expand = c(0, 0)) +
  ylab("Proportion") +
  xlab("") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank()) 
```
```{r}
fig_S1_B = exp1data_punish_types_times %>%
  ggplot() +
  aes(x = punish_type, y = mean_dt) +
  geom_bar(stat = "identity", width = 0.75, fill = "darkseagreen3", alpha = 0.5) +
  geom_errorbar(aes(ymin = mean_LL, 
                    ymax = mean_UL),
                color = "forestgreen", width = 0) +
  theme_classic() +
  scale_y_continuous(limits = c(0, 10), breaks = seq(0, 8, by = 2), expand = c(0, 0)) +
  ylab("Decision time \n (seconds)")+
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())

fig_S1_A / fig_S1_B + plot_annotation(tag_levels = c("A", "B"))

ggsave(filename = "~/Documents/Projects/harming_esn/figures/figS1.png", width = 7, height = 5, units = "in")
```


## Supplementary Figure - Figure S2, stratified by previous punish status

```{r}
# Get the distribution of punish rate among punishers in Expt. 2

fig4data %>%
  filter(round > 1, is.na(local_rate_punish_lag) == F) %>%
  ggplot() +
  geom_histogram(aes(x = local_rate_punish_lag), binwidth = 0.1)
```

```{r}
fig4data_prev_punish = fig4data %>% filter(behavior_punish_lag == 1)
fig4data_prev_no_punish = fig4data %>% filter(behavior_punish_lag == 0)

# Get the frequencies stratified by TP status and by punishment type
fig4_tp_minus_CR_pp = fig4data_prev_punish %>% 
  filter(time_pressure == "Minus") %>%
  group_by(punish_type_CR) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP-",
         punish_type = "CR",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_CR == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_minus_IA_pp = fig4data_prev_punish %>% 
  filter(time_pressure == "Minus") %>%
  group_by(punish_type_IA) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP-",
         punish_type = "IA",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_IA == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_minus_NR_pp = fig4data_prev_punish %>% 
  filter(time_pressure == "Minus") %>%
  group_by(punish_type_NR) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP-",
         punish_type = "NR",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_NR == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_minus_U_pp = fig4data_prev_punish %>% 
  filter(time_pressure == "Minus") %>%
  group_by(punish_type_U) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP-",
         punish_type = "U",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_U == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_minus_data_pp = bind_rows(fig4_tp_minus_CR_pp,
                                  fig4_tp_minus_IA_pp,
                                  fig4_tp_minus_NR_pp,
                                  fig4_tp_minus_U_pp)

fig4_tp_Plus_CR_pp = fig4data_prev_punish %>% 
  filter(time_pressure == "Plus") %>%
  group_by(punish_type_CR) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP+",
         punish_type = "CR",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_CR == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_Plus_IA_pp = fig4data_prev_punish %>% 
  filter(time_pressure == "Plus") %>%
  group_by(punish_type_IA) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP+",
         punish_type = "IA",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_IA == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_Plus_NR_pp = fig4data_prev_punish %>% 
  filter(time_pressure == "Plus") %>%
  group_by(punish_type_NR) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP+",
         punish_type = "NR",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_NR == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_Plus_U_pp = fig4data_prev_punish %>% 
  filter(time_pressure == "Plus") %>%
  group_by(punish_type_U) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP+",
         punish_type = "U",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_U == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_Plus_data_pp = bind_rows(fig4_tp_Plus_CR_pp, 
                              fig4_tp_Plus_IA_pp, 
                              fig4_tp_Plus_NR_pp, 
                              fig4_tp_Plus_U_pp)

fig4data_combined_pp = bind_rows(fig4_tp_minus_data_pp, fig4_tp_Plus_data_pp)
```
```{r}
# Run the regression models for each condition to test the effect of time pressure to get p-values
fig4_model_NR = glmer(punish_type_NR ~ time_pressure + factor(round) + (1|game) + (1|superid), data = fig4data_prev_punish, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))
tidy(fig4_model_NR, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(10) # p = 0.9884
```
```{r}
fig4_model_CR = glmer(punish_type_CR ~ time_pressure + factor(round) + (1|game) + (1|superid), data = fig4data_prev_punish, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))
tidy(fig4_model_CR, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(10) # p = 0.253
```
```{r}
fig4_model_IA = glmer(punish_type_IA ~ time_pressure + factor(round) + (1|game) + (1|superid), data = fig4data_prev_punish, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))
tidy(fig4_model_IA, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(10) # p = 0.919
```
```{r}
fig4_model_U = glmer(punish_type_U ~ time_pressure + factor(round) + (1|game) + (1|superid), data = fig4data, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))
tidy(fig4_model_U, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(10) # p = 0.999
```

### Figure - previous punish
```{r}
fig4_pp = fig4data_combined_pp %>%
  ggplot(aes(x = punish_type, y = perc, fill = setting)) +
  geom_bar(position = "dodge", stat = "identity", alpha = 0.5, show.legend = T) +
  geom_errorbar(aes(ymin = perc + 1.96*se_perc, 
                    ymax = perc - 1.96*se_perc,
                    color = factor(setting),
                    width = 0),
                position = position_dodge(.9),
                show.legend = F) +
  geom_text(aes(label = n, group = setting), position = position_dodge(.9), vjust = 3) +
  annotate("text", x = 1:3, 
           y = c(0.4, 0.75, 0.5), 
           label = c("italic(p) == 0.253", "italic(p) == 0.919", "italic(p) == 0.988"), 
           parse = T) +
  scale_fill_manual(values = c("slategray2", "goldenrod2"),
                    labels = c("TP-", "TP+"))+
  scale_color_manual(values = c("dodgerblue4", "darkorange3"), guide = "none") +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0)) +
  ylab("Proportion of punishment") +
  xlab("") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank()) 
fig4_pp
```

```{r}
fig4_tp_minus_CR_np = fig4data_prev_no_punish %>% 
  filter(time_pressure == "Minus") %>%
  group_by(punish_type_CR) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP-",
         punish_type = "CR",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_CR == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_minus_IA_np = fig4data_prev_no_punish %>% 
  filter(time_pressure == "Minus") %>%
  group_by(punish_type_IA) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP-",
         punish_type = "IA",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_IA == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_minus_NR_np = fig4data_prev_no_punish %>% 
  filter(time_pressure == "Minus") %>%
  group_by(punish_type_NR) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP-",
         punish_type = "NR",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_NR == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_minus_U_np = fig4data_prev_no_punish %>% 
  filter(time_pressure == "Minus") %>%
  group_by(punish_type_U) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP-",
         punish_type = "U",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_U == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_minus_data_np = bind_rows(fig4_tp_minus_CR_np,
                                  fig4_tp_minus_IA_np,
                                  fig4_tp_minus_NR_np,
                                  fig4_tp_minus_U_np)

fig4_tp_Plus_CR_np = fig4data_prev_no_punish %>% 
  filter(time_pressure == "Plus") %>%
  group_by(punish_type_CR) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP+",
         punish_type = "CR",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_CR == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_Plus_IA_np = fig4data_prev_no_punish %>% 
  filter(time_pressure == "Plus") %>%
  group_by(punish_type_IA) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP+",
         punish_type = "IA",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_IA == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_Plus_NR_np = fig4data_prev_no_punish %>% 
  filter(time_pressure == "Plus") %>%
  group_by(punish_type_NR) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP+",
         punish_type = "NR",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_NR == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_Plus_U_np = fig4data_prev_no_punish %>% 
  filter(time_pressure == "Plus") %>%
  group_by(punish_type_U) %>%
  count() %>%
  ungroup() %>%
  mutate(setting = "TP+",
         punish_type = "U",
         total = sum(n),
         perc = n/sum(n),
         se_perc = sqrt((perc*(1-perc))/total)) %>%
  filter(punish_type_U == 1)  %>%
  select(setting, punish_type, n, total, perc, se_perc)

fig4_tp_Plus_data_np = bind_rows(fig4_tp_Plus_CR_np, 
                              fig4_tp_Plus_IA_np, 
                              fig4_tp_Plus_NR_np, 
                              fig4_tp_Plus_U_np)

fig4data_combined_np = bind_rows(fig4_tp_minus_data_np, fig4_tp_Plus_data_np)
```
```{r}
fig4_model_NR = glmer(punish_type_NR ~ time_pressure + factor(round) + (1|game) + (1|superid), data = fig4data_prev_no_punish, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))
tidy(fig4_model_NR, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(10) # p = 0.5923
```
```{r}
fig4_model_CR = glmer(punish_type_CR ~ time_pressure + factor(round) + (1|game) + (1|superid), data = fig4data_prev_no_punish, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))
tidy(fig4_model_CR, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(10) # p = 0.534
```
```{r}
fig4_model_IA = glmer(punish_type_IA ~ time_pressure + factor(round) + (1|game) + (1|superid), data = fig4data_prev_no_punish, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))
tidy(fig4_model_IA, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(10) # p = 0.820
```
```{r}
fig4_model_U = glmer(punish_type_U ~ time_pressure + factor(round) + (1|game) + (1|superid), data = fig4data_prev_no_punish , family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))
tidy(fig4_model_U, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(10) # p = 1
```
### Figure - no previous punish

```{r}
fig4_np = fig4data_combined_np %>%
  filter(punish_type != "U") %>%
  ggplot(aes(x = punish_type, y = perc, fill = setting)) +
  geom_bar(position = "dodge", stat = "identity", alpha = 0.5, show.legend = T) +
  geom_errorbar(aes(ymin = perc + 1.96*se_perc, 
                    ymax = perc - 1.96*se_perc,
                    color = factor(setting),
                    width = 0),
                position = position_dodge(.9),
                show.legend = F) +
  geom_text(aes(label = n, group = setting), position = position_dodge(.9), vjust = 3) +
  annotate("text", x = 1:3, 
           y = c(0.4, 0.7, 0.95), 
           label = c("italic(p) == 0.534", "italic(p) == 0.820", "italic(p) == 0.592"), 
           parse = T) +
  scale_fill_manual(values = c("slategray2", "goldenrod2"),
                    labels = c("TP-", "TP+"))+
  scale_color_manual(values = c("dodgerblue4", "darkorange3"), guide = "none") +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0)) +
  ylab("Proportion of punishment") +
  xlab("") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank()) 
```

### Combined

```{R}
fig4_pp / fig4_np + 
  plot_annotation(tag_levels = c("A", "B")) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.key.size = unit(0.15, "in")) 
```


## Manuscript Figure 5 - Behavior frequencies, Experiment 1

```{r}
fig2data = bind_rows(exp1_behaviors_sum, exp4_tp_minus_behaviors_sum, exp4_tp_plus_behavior_sum) %>%
  filter(is.na(behavior) == F) %>%
  mutate(se_perc = sqrt((perc*(1-perc))/total),
         environment = ifelse(environment == "Cooperative", "Cooperative environment",
                              "Non-cooperative environment"),
         expt = case_when(expt == "A" ~ "1",
                          expt == "B, TP-" ~ "2, TP-",
                          expt == "B, TP+" ~ "2, TP+"))
         
```

```{r}
fig2 = fig2data %>%
  ggplot(aes(fill = behavior, y = perc, x = expt)) +
  geom_bar(position = "dodge", stat = "identity", alpha = 0.5) +
  geom_errorbar(aes(ymin = perc - 1.96*se_perc, 
                    ymax = perc + 1.96*se_perc,
                    color = factor(behavior),
                    width = 0),
                position = position_dodge(.9),
                show.legend = F) +
  facet_wrap(~environment,
             scales = "free_x") +
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2"),
                    labels = c("Cooperation", "Defection", "Punishment")) +
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  scale_y_continuous(limits = c(0, 0.8), expand = c(0, 0)) +
  xlab("") +
  ylab("Proportion") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())


fig2
```

## Figure 3 - Behavior frequencies and times by social environment, 3 experimental settings

```{r}
exp1_times_sum$expt = "A"
exp4_tp_plus_sum$expt = "B, TP+"
exp4_tp_minus_sum$expt = "B, TP-"
fig3data = bind_rows(exp1_times_sum, exp4_tp_minus_sum, exp4_tp_plus_sum) %>%
  mutate(environment = ifelse(environment == "Cooperative", "Cooperative environment",
                              "Non-cooperative environment"),
                  expt = case_when(expt == "A" ~ "1",
                          expt == "B, TP-" ~ "2, TP-",
                          expt == "B, TP+" ~ "2, TP+"))
         
```

```{r}
fig3 = fig3data %>%
  ggplot(aes(fill = behavior, y = mean_dt, x = expt)) +
  geom_bar(position = "dodge", stat = "identity", alpha = 0.5, show.legend = F) +
  geom_errorbar(aes(ymin = mean_dt - 1.96*se_mean_dt, 
                    ymax = mean_dt + 1.96*se_mean_dt,
                    color = factor(behavior),
                    width = 0),
                position = position_dodge(.9),
                show.legend = F) +
  facet_wrap(~environment) +
  scale_fill_manual(values = c("#00A5CF", "#FFBF00", "#574AE2"),
                    labels = c("Cooperation", "Defection", "Punishment"))+
  scale_color_manual(values = c("dodgerblue4", "darkorange3", "#574AE2")) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 8)) +
  ylab("Mean decision time (seconds)") +
  xlab("") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.title = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank()) 
fig3
```

### Merge figs 2 and 3

```{r}
(fig2 / fig3) + plot_layout(guides = "collect") &
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.key.size = unit(0.15, "in")) 

ggsave(filename = "~/Documents/Projects/harming_esn/figures/fig3.png", width = 7, height = 7, units = "in")
```

## Supplementary Figure 1 - Rate of punishment by round

```{r}
exp1_round_totals = exp1data %>% 
  group_by(round) %>%
  count() %>%
  rename(total = n)

exp2_tp_minus_round_totals = exp4data %>%
  filter(time_pressure == "Minus") %>%
  group_by(round) %>%
  count() %>%
  rename(total = n)

exp2_tp_plus_round_totals = exp4data %>%
  filter(time_pressure == "Plus") %>%
  group_by(round) %>%
  count() %>%
  rename(total = n)
```

```{r}
fig_s1_d1 = exp1data %>%
  group_by(behavior, round) %>%
  count(behavior) %>%
  filter(behavior == "P") %>%
  left_join(exp1_round_totals, by = "round") %>%
  mutate(rate = n/total,
         rate_UL = rate + 1.96*sqrt((rate*(1-rate))/total),
         rate_LL = rate - 1.96*sqrt((rate*(1-rate))/total),
         expt = "1")

fig_s1_d2 = exp4data %>%
  filter(time_pressure == "Minus") %>%
  group_by(behavior, round) %>%
  count(behavior) %>%
  filter(behavior == "P") %>%
  left_join(exp2_tp_minus_round_totals, by = "round") %>%
  mutate(rate = n/total,
         rate_UL = rate + 1.96*sqrt((rate*(1-rate))/total),
         rate_LL = rate - 1.96*sqrt((rate*(1-rate))/total),
         expt = "2, TP-")

fig_s1_d3 = exp4data %>%
  filter(time_pressure == "Plus") %>%
  group_by(behavior, round) %>%
  count(behavior) %>%
  filter(behavior == "P") %>%
  left_join(exp2_tp_plus_round_totals, by = "round") %>%
  mutate(rate = n/total,
         rate_UL = rate + 1.96*sqrt((rate*(1-rate))/total),
         rate_LL = rate - 1.96*sqrt((rate*(1-rate))/total),
         expt = "2, TP+")

fig_s1_data = bind_rows(fig_s1_d1, fig_s1_d2, fig_s1_d3)
```

```{r}
fig_s1_data %>%
  ggplot() +
  geom_line(aes(x = round, y = rate, group = expt, color = expt)) +
  geom_ribbon(aes(x = round, ymin = rate_LL, ymax = rate_UL, group = expt, fill = expt), alpha = 0.2) +
  scale_color_manual(values = c("1" = "darkgreen", "2, TP-" = "lightskyblue4", "2, TP+" = "salmon"))+
  scale_fill_manual(values = c("1" = "palegreen", "2, TP-" = "lightblue", "2, TP+" = "pink")) +
  scale_x_continuous(limits = c(1, 15), breaks = c(1, 5, 10, 15)) +
  theme_classic() +
  ylab("Frequency of punishment") +
  xlab("Round") +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank()) 
```

# Regression modeling

## Punishment as the outcome

```{r}
m1 = glmer(behavior_punish ~ showScore + behavior_coop_lag + local_rate_coop_lag + behavior_punish_lag + local_rate_punish_lag + factor(round) + (1|game) + (1|superid), data = exp1data %>% filter(round > 0), family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

tidy(m1, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(10) 
```

```{r}
m2 = glmer(behavior_punish ~ time_pressure + round + (1|game) + (1|superid),  data = exp4data %>% filter(round > 0), family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

summary(m2)

tidy(m2, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(3) 
```

```{r}
m3 = glmer(behavior_punish ~ time_pressure +  behavior_coop_lag + local_rate_coop_lag + behavior_punish_lag + local_rate_punish_lag + cPayoffS_lag + degree_lag + factor(round) + (1|game) + (1|superid),  data = exp4_modeling, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

tidy(m3, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

## Cooperation as the outcome

```{r}
m2.1 = glmer(behavior_coop ~ time_pressure + factor(round) + (1|game) + (1|superid),  data = exp4_modeling, family = binomial, nAGQ=0, control = glmerControl(optimizer = c("bobyqa"), optCtrl=list(maxfun=2e5), calc.derivs=FALSE))

tidy(m2.1, conf.int=TRUE, exponentiate=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) 
```

## Behavior time as the outcome

## Exp A - All rounds

```{r}
m4 = lmer(behaviorTime_sec_adj ~ behavior + round + (1|game) + (1|superid), data = exp1data)
summary(m4)
tidy(m4, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

## Exp B - controlling for time pressure

```{r}
exp4_tp_plus = exp4data %>% filter(time_pressure == "Plus")
exp4_tp_minus = exp4data %>% filter(time_pressure == "Minus")

m5a = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4_tp_plus)
summary(m5a)
tidy(m5a, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

```{r}
m5b = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4_tp_minus)

summary(m5b)

tidy(m5b, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 

```

## Exp A - Regression model for unknown environment

```{r}
data1_unk_env = exp1data %>% filter(social_env_lag == "U")

m6 = lmer(logbehaviorTime_sec_adj ~ behavior + factor(round) + (1|game) + (1|superid), data = data1_unk_env)
tidy(m6, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

## Exp B - regression model for unknown environment

```{r}
exp4data_unk_minus = exp4data %>% filter(social_env_lag == "U", time_pressure == "Minus")

m7 = lmer(log10(behaviorTime_sec) ~ behavior + factor(round) + (1|game) + (1|superid), data = exp4data_unk_minus)
tidy(m7, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

```{r}
m8 = lmer(behaviorTime_sec_adj ~ behavior + factor(round) + (1|game) + (1|superid), data = data1_punish_prev)
tidy(m8, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

## Exp A - Regression model for cooperative environment

```{r}
data1_coop_env = exp1data %>% filter(social_env_lag == "C")

m9 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = data1_coop_env)
summary(m9)
tidy(m9, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

### Exp A - Sensitivity Analysis: adjusting the threshold for social environment

#### Threshold = 0.4

```{r}
data1_coop_env_0.4 = exp1data %>% filter(social_env_lag0.4 == "C")

m9_0.4 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = data1_coop_env_0.4)
summary(m9_0.4)
tidy(m9_0.4, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

#### Threshold = 0.6 

```{r}
data1_coop_env_0.6 = exp1data %>% filter(social_env_lag0.6 == "C")

m9_0.6 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = data1_coop_env_0.6)
summary(m9_0.6)
tidy(m9_0.6, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

#### Threshold = 0.7

```{r}
data1_coop_env_0.7 = exp1data %>% filter(social_env_lag0.7 == "C")

m9_0.7 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = data1_coop_env_0.7)
summary(m9_0.7)

tidy(m9_0.7, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

#### Threshold = 0.8

```{r}
data1_coop_env_0.8 = exp1data %>% filter(social_env_lag0.8 == "C")

m9_0.8 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = data1_coop_env_0.8)
summary(m9_0.8)

tidy(m9_0.8, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

#### Threshold = 0.9

```{r}
data1_coop_env_0.9 = exp1data %>% filter(social_env_lag0.9 == "C")

m9_0.9 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = data1_coop_env_0.9)
summary(m9_0.9)

tidy(m9_0.9, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 

exp1data %>% group_by(social_env_lag0.8) %>%
  count()
```

## Exp B - Regression model for cooperative environment

```{r}
exp4data_coop_minus = exp4data %>% filter(social_env_lag == "C", time_pressure == "Minus")

m10a = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_coop_minus)

summary(m10a)
tidy(m10a, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

```{r}
exp4data_coop_plus = exp4data %>% filter(social_env_lag == "C", time_pressure == "Plus")

m10b = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_coop_plus)

summary(m10b)
tidy(m10b, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

### Exp B - Sensitivity Analysis: adjusting threshold for environment (TP-)

#### Threshold = 0.4

```{r}
exp4data_coop_minus_0.4 = exp4data %>% filter(social_env_lag0.4 == "C", time_pressure == "Minus")

m10a_0.4 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_coop_minus_0.4)

summary(m10a_0.4)
```

#### Threshold = 0.6

```{r}
exp4data_coop_minus_0.6 = exp4data %>% filter(social_env_lag0.6 == "C", time_pressure == "Minus")

m10a_0.6 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_coop_minus_0.6)

summary(m10a_0.6)
```

#### Threshold = 0.7

```{r}
exp4data_coop_minus_0.7 = exp4data %>% filter(social_env_lag0.7 == "C", time_pressure == "Minus")

m10a_0.7 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_coop_minus_0.7)

summary(m10a_0.7)
```

#### Threshold = 0.8

```{r}
exp4data_coop_minus_0.8 = exp4data %>% filter(social_env_lag0.8 == "C", time_pressure == "Minus")

m10a_0.8 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_coop_minus_0.8)

summary(m10a_0.8)
```

#### Threshold = 0.9

```{r}
exp4data_coop_minus_0.9 = exp4data %>% filter(social_env_lag0.9 == "C", time_pressure == "Minus")

m10a_0.9 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_coop_minus_0.9)

summary(m10a_0.9)
```

### Exp B - Sensitivity Analysis: adjusting threshold for environment (TP+)

#### Threshold = 0.4

```{r}
exp4data_coop_plus_0.4 = exp4data %>% filter(social_env_lag0.4 == "C", time_pressure == "Plus")

m10b_0.4 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_coop_plus_0.4)

summary(m10b_0.4)
```
#### Threshold = 0.6

```{r}
exp4data_coop_plus_0.6 = exp4data %>% filter(social_env_lag0.6 == "C", time_pressure == "Plus")

m10b_0.6 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_coop_plus_0.6)

summary(m10b_0.6)
```
#### Threshold = 0.7

```{r}
exp4data_coop_plus_0.7 = exp4data %>% filter(social_env_lag0.7 == "C", time_pressure == "Plus")

m10b_0.7 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_coop_plus_0.7)

summary(m10b_0.7)
```
#### Threshold = 0.8

```{r}
exp4data_coop_plus_0.8 = exp4data %>% filter(social_env_lag0.8 == "C", time_pressure == "Plus")

m10b_0.8 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_coop_plus_0.8)

summary(m10b_0.8)
```
#### Threshold = 0.9

```{r}
exp4data_coop_plus_0.9 = exp4data %>% filter(social_env_lag0.9 == "C", time_pressure == "Plus")

m10b_0.9 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_coop_plus_0.9)

summary(m10b_0.9)
```

## Exp A - Regression model for uncooperative environment

```{r}
data1_noncoop_env = exp1data %>% filter(social_env_lag == "NC")

m11 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = data1_noncoop_env)

summary(m11)
tidy(m11, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

### Exp A - Sensitvity Analysis: adjusting threshold

#### Threshold = 0.4

```{r}
data1_noncoop_env_0.4 = exp1data %>% filter(social_env_lag0.4 == "NC")

m11_0.4 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = data1_noncoop_env_0.4)
summary(m11_0.4)
```

#### Threshold = 0.6

```{r}
data1_noncoop_env_0.6 = exp1data %>% filter(social_env_lag0.6 == "NC")

m11_0.6 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = data1_noncoop_env_0.6)
summary(m11_0.6)
```

#### Threshold = 0.7

```{r}
data1_noncoop_env_0.7 = exp1data %>% filter(social_env_lag0.7 == "NC")

m11_0.7 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = data1_noncoop_env_0.7)
summary(m11_0.7)
```
#### Threshold = 0.8

```{r}
data1_noncoop_env_0.8 = exp1data %>% filter(social_env_lag0.8 == "NC")

m11_0.8 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = data1_noncoop_env_0.8)
summary(m11_0.8)
```

#### Threshold = 0.9

```{r}
data1_noncoop_env_0.9 = exp1data %>% filter(social_env_lag0.9 == "NC")

m11_0.9 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = data1_noncoop_env_0.9)
summary(m11_0.9)
```

## Exp B - Regression model for uncooperative environment

```{r}
exp4data_noncoop_minus = exp4data %>% filter(social_env_lag == "NC", time_pressure == "Minus")

m12a = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_noncoop_minus)
summary(m12a)
tidy(m12a, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

```{r}
exp4data_noncoop_plus = exp4data %>% filter(social_env_lag == "NC", time_pressure == "Plus")

m12b = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_noncoop_plus)
summary(m12b)
tidy(m12b, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

### Exp B - Sensitvity Analysis: adjusting threshold

#### Threshold = 0.4

```{r}
exp4data_noncoop_minus_0.4 = exp4data %>% filter(social_env_lag0.4 == "NC", time_pressure == "Minus")

m12a_0.4 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_noncoop_minus_0.4)

summary(m12a_0.4)
```

#### Threshold = 0.6

```{r}
exp4data_noncoop_minus_0.6 = exp4data %>% filter(social_env_lag0.6 == "NC", time_pressure == "Minus")

m12a_0.6 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_noncoop_minus_0.6)

summary(m12a_0.6)
```

#### Threshold = 0.7

```{r}
exp4data_noncoop_minus_0.7 = exp4data %>% filter(social_env_lag0.7 == "NC", time_pressure == "Minus")

m12a_0.7 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_noncoop_minus_0.7)

summary(m12a_0.7)
```
#### Threshold = 0.8

```{r}
exp4data_noncoop_minus_0.8 = exp4data %>% filter(social_env_lag0.8 == "NC", time_pressure == "Minus")

m12a_0.8 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_noncoop_minus_0.8)

summary(m12a_0.8)
```
#### Threshold = 0.9

```{r}
exp4data_noncoop_minus_0.9 = exp4data %>% filter(social_env_lag0.9 == "NC", time_pressure == "Minus")

m12a_0.9 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_noncoop_minus_0.9)

summary(m12a_0.9)
```

### Exp B - Sensitivity Analysis: adjusting threshold (TP+)

#### Threshold = 0.4

```{r}
exp4data_noncoop_plus_0.4 = exp4data %>% filter(social_env_lag0.4 == "NC", time_pressure == "Plus")

m12a_0.4 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_noncoop_plus_0.4)

summary(m12a_0.4)
```
#### Threshold = 0.6

```{r}
exp4data_noncoop_plus_0.6 = exp4data %>% filter(social_env_lag0.6 == "NC", time_pressure == "Plus")

m12a_0.6 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_noncoop_plus_0.6)

summary(m12a_0.6)
```
#### Threshold = 0.7

```{r}
exp4data_noncoop_plus_0.7 = exp4data %>% filter(social_env_lag0.7 == "NC", time_pressure == "Plus")

m12a_0.7 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_noncoop_plus_0.7)

summary(m12a_0.7)
```
#### Threshold = 0.8

```{r}
exp4data_noncoop_plus_0.8 = exp4data %>% filter(social_env_lag0.8 == "NC", time_pressure == "Plus")

m12a_0.8 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_noncoop_plus_0.8)

summary(m12a_0.8)
```

#### Threshold = 0.9

```{r}
exp4data_noncoop_plus_0.9 = exp4data %>% filter(social_env_lag0.9 == "NC", time_pressure == "Plus")

m12a_0.9 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4data_noncoop_plus_0.9)

summary(m12a_0.9)
```



# Exp A - Regression model with and without punishment in round t-1

```{r}
m13 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp1_last_punished)

summary(m13)
tidy(m13, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```
## Punish Decision Time with last punish vs. not

```{r}
exp1_punish_data = exp1data %>%
  mutate(last_punished = ifelse(local_rate_punish_lag > 0, 1, 0)) %>%
  filter(behavior_punish == 1)
m13 = lmer(behaviorTime_sec_adj ~ last_punished + round + (1|game) + (1|superid), data = exp1_punish_data)

summary(m13)
tidy(m13, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(2) 
```


```{r}
m14 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp1_last_no_punish)
summary(m14)
tidy(m14, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

## Exp B, TP-: Regression model with and without punishment

```{r}
exp4data_minus_lp = exp4data %>%
  mutate(last_punished = ifelse(local_rate_punish_lag > 0, 1, 0)) %>%
  filter(behavior_punish == 1, time_pressure == "Minus")
exp4data_plus_lp = exp4data %>%
  mutate(last_punished = ifelse(local_rate_punish_lag > 0, 1, 0)) %>%
  filter(behavior_punish == 1, time_pressure == "Plus")
m15 = lmer(behaviorTime_sec ~ last_punished + round + (1|game) + (1|superid), data = exp4data_plus_lp)

summary(m15)

tidy(m15, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

```{r}
m16 = lmer(behaviorTime_sec ~ behavior + round + (1|game) + (1|superid), data = exp4_tp_minus_last_nopunish)
summary(m16)
tidy(m16, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

## Exp B, TP+: model with and without punish in last round

```{r}
m17 = lmer(log10(behaviorTime_sec) ~ behavior + round + (1|game) + (1|superid), data = exp4_tp_plus_last_punished)

summary(m17)
tidy(m17, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

```{r}
m18 = lmer(log10(behaviorTime_sec) ~ behavior + round + (1|game) + (1|superid), data = exp4_tp_plus_last_nopunish)

summary(m18)

tidy(m18, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

## Payoff as the outcome

```{r, warning = F, message = F}
m19 = lmer(cPayoffS ~ behavior + factor(round) + (1|game) + (1|superid), data = exp1data)

tidy(m19, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

```{r}
m20 = lmer(cPayoffS ~ behavior + factor(round) + (1|game) + (1|superid), data = exp4data %>% filter(time_pressure == "Minus"))

tidy(m20, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

```{r}
m21 = lmer(cPayoffS ~ behavior + factor(round) + (1|game) + (1|superid), data = exp4data %>% filter(time_pressure == "Plus"))

tidy(m21, conf.int=TRUE) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  rename(Term = term, Estimate = estimate, 
         LL = conf.low, UL = conf.high, p = p.value) %>%
  mutate(across(where(is.numeric), round, 4)) %>%
  select(Term, Estimate, LL, UL, p) %>%
  head(8) 
```

\`\`\`
